<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="meta.title">AI å¿ƒç†ç­†è¨˜</title>
    <meta name="description" data-i18n="meta.description" content="ä¸€å€‹ä»¥æ‚¨ç‚ºä¸­å¿ƒçš„ç§å¯†ç©ºé–“ï¼Œæ›¸å¯«å¿ƒæƒ…ã€å›é¡§è¶³è·¡ï¼Œä¸¦åœ¨éœ€è¦æ™‚èˆ‡æº«æš–çš„ AI å¿ƒç†å¸«å°è©±ã€‚">
    <meta name="keywords" content="å¿ƒç†å¥åº·, å¿ƒæƒ…æ—¥è¨˜, AIå¿ƒç†å¸«, è‡ªæˆ‘é—œæ‡·, å‘¼å¸ç·´ç¿’, Mental Health, Mood Journal, AI Therapist">
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary-color: #a0522d; /* Sienna - æš–æ£•è‰² */
            --primary-color-hover: #8b4513; /* SaddleBrown */
            --secondary-color: #c9a988; /* æŸ”å’Œçš„æ£•è¤è‰² */
            --text-color: #3d2b1f; /* Dark Brown */
            --text-light-color: #6b4f3a;
            --bg-color: #f5f5dc; /* Beige - ç±³è‰²èƒŒæ™¯ */
            --card-bg-color: #fffaf0; /* FloralWhite - å¡ç‰‡èƒŒæ™¯ */
            --input-bg-color: #fdf5e6; /* OldLace - è¼¸å…¥æ¡†èƒŒæ™¯ */
            --border-color: #dcd0b8;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        /* ä¸»é¡Œè‰²ç³»æ‡‰ç”¨ */
        .theme-primary { color: var(--primary-color); }
        .theme-bg-primary { background-color: var(--primary-color); }
        .theme-bg-primary-hover:hover:not(:disabled) { background-color: var(--primary-color-hover); }
        .theme-text { color: var(--text-color); }
        .theme-text-light { color: var(--text-light-color); }
        .theme-bg-card { background-color: var(--card-bg-color); }
        .theme-bg-input { background-color: var(--input-bg-color); }
        .theme-border { border-color: var(--border-color); }
        .theme-ring-focus:focus { --tw-ring-color: var(--primary-color); }
        /* Modal å‹•ç•« */
        .modal { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        /* è®€å–ä¸­ Spinner */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { animation: spin 0.8s linear infinite; border-top-color: var(--primary-color); }
        /* æç¤ºè¨Šæ¯ */
        #notification-container {
            position: fixed; top: 1.25rem; left: 50%;
            transform: translateX(-50%); z-index: 250;
            width: 90%; max-width: 24rem;
            display: flex; flex-direction: column; gap: 0.75rem; align-items: center;
        }
        .notification {
            width: 100%; text-align: center;
            padding: 0.75rem 1.5rem; border-radius: 9999px;
            color: white; font-weight: 700;
            opacity: 0; transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        /* èŠå¤©æ³¡æ³¡ */
        .chat-bubble-container { display: flex; align-items: flex-end; gap: 0.5rem; max-width: 90%; }
        .chat-bubble { max-width: 100%; word-wrap: break-word; line-height: 1.6; }
        .chat-bubble-user { background-color: var(--secondary-color); }
        .chat-bubble-assistant { background-color: var(--primary-color); }
        .chat-timestamp { font-size: 0.7rem; color: var(--text-light-color); flex-shrink: 0; }
        /* å¡ç‰‡æ‡¸æµ®æ•ˆæœ */
        .card-hover-effect:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(160, 82, 45, 0.1), 0 4px 6px -2px rgba(160, 82, 45, 0.08);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        /* å‘¼å¸ç·´ç¿’å‹•ç•« */
        @keyframes pulse-breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        .breathing-circle {
            animation: pulse-breathe 8s ease-in-out infinite;
        }
        /* å¿ƒæƒ…å„€è¡¨æ¿æ©«æ¢ */
        .mood-bar-bg {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            height: 1.25rem; /* h-5 */
            overflow: hidden;
            width: 100%;
        }
        .mood-bar-visual {
            height: 100%;
            border-radius: 9999px;
            transition: width 1s ease-out, background-color 1s ease-out;
            background-image: linear-gradient(to right, #60a5fa, #34d399, #facc15, #f97316);
        }
        /* é€šç”¨ Modal å…§å®¹æ¨£å¼ */
        .modal-prose h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.75rem; /* mb-3 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 1px solid var(--border-color);
        }
        .modal-prose p, .modal-prose ul, .modal-prose ol {
            margin-bottom: 1rem; /* mb-4 */
            line-height: 1.75; /* leading-relaxed */
        }
        .modal-prose ul, .modal-prose ol {
            padding-left: 1.5rem; /* pl-6 */
        }
        .modal-prose ul { list-style-type: disc; }
        .modal-prose ol { list-style-type: decimal; }
        .modal-prose li { margin-bottom: 0.75rem; /* mb-3 */ }
        .modal-prose i.ph-bold { vertical-align: -0.125em; }
    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4 pt-8 sm:pt-12 pb-32">

    <!-- === ä¸»å…§å®¹å€åŸŸ === -->
    <main class="w-full max-w-3xl mx-auto flex flex-col gap-8">

        <!-- Header -->
        <header class="w-full theme-bg-card rounded-2xl shadow-lg p-4 sm:p-6 relative">
            <div class="absolute top-4 left-4 sm:left-6">
                <button data-modal-target="other-apps-modal" class="text-xs sm:text-sm theme-text-light hover:theme-text transition-colors flex items-center gap-1" data-i18n="header.other_apps">
                    <i class="ph-bold ph-app-window"></i>
                    <span>ä½œè€…é–‹ç™¼çš„å…¶ä»–æ‡‰ç”¨</span>
                </button>
            </div>
            <div class="absolute top-4 right-4 flex items-center gap-4">
                <a href="https://buymeacoffee.com/arvincreator" target="_blank" rel="noopener noreferrer" class="theme-text-light hover:theme-text transition-colors" data-i18n-title="header.sponsor">
                    <i class="ph-bold ph-coffee text-xl"></i>
                </a>
                <button data-modal-target="info-modal" class="theme-text-light hover:theme-text transition-colors" data-i18n-title="header.info">
                    <i class="ph-bold ph-info text-xl"></i>
                </button>
                <button id="open-settings-modal-btn" data-modal-target="settings-modal" class="theme-text-light hover:theme-text transition-colors" data-i18n-title="header.settings">
                    <i class="ph-bold ph-gear text-xl"></i>
                </button>
            </div>
            <div class="text-center pt-12 sm:pt-8">
                <i class="ph-duotone ph-leaf text-5xl sm:text-6xl theme-primary"></i>
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-black theme-text mt-4 mb-2" data-i18n="title">AI å¿ƒç†ç­†è¨˜</h1>
                <p class="theme-text-light text-sm mb-2" data-i18n="subtitle">ä¸€å€‹æ‡‚ä½ ã€å‚¾è½ä½ çš„ç§å¯†å¿ƒéˆç©ºé–“</p>
            </div>
        </header>

        <!-- å®‰å¿ƒæé†’ -->
        <section class="w-full bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-r-lg">
            <h3 class="font-bold flex items-center gap-2"><i class="ph-fill ph-shield-warning"></i><span data-i18n="reminder.title">å®‰å¿ƒæé†’</span></h3>
            <p class="text-sm mt-1" data-i18n="reminder.content">æˆ‘æ˜¯ä¸€ä½ AI å¿ƒç†å¸«ï¼Œèƒ½æä¾›æ”¯æŒèˆ‡å¼•å°ï¼Œä½†ç„¡æ³•å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚è‹¥æ‚¨æ„Ÿåˆ°éå¸¸ç—›è‹¦ï¼Œè«‹å‹™å¿…å°‹æ±‚<a href="#resources" class="font-bold underline hover:text-yellow-900" data-i18n="reminder.link">å°ˆæ¥­å”åŠ©</a>ã€‚</p>
        </section>

        <!-- å¿ƒæƒ…é›œè¨˜è¼¸å…¥ -->
        <section class="w-full theme-bg-card rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="ph-fill ph-pencil-line theme-primary"></i> <span data-i18n="journal.title">å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…</span></h2>
            <form id="journal-form" class="space-y-5">
                <div>
                    <label for="journal-content" class="sr-only" data-i18n="journal.label">é›œè¨˜å…§å®¹</label>
                    <textarea id="journal-content" rows="6" class="w-full theme-bg-input theme-border theme-text rounded-lg focus:ring-2 theme-ring-focus focus:border-transparent block p-4 text-base" data-i18n-placeholder="journal.placeholder" required></textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                    <button id="open-history-modal-btn" type="button" class="w-full bg-white border theme-border hover:bg-gray-50 text-gray-700 font-bold text-lg py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                        <i class="ph-fill ph-book-open"></i>
                        <span data-i18n="journal.history_button">å›é¡§å¿ƒæƒ…è¶³è·¡</span>
                    </button>
                    <button id="save-journal-btn" type="submit" class="w-full theme-bg-primary theme-bg-primary-hover text-white font-bold text-lg py-3 px-4 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                        <i class="ph-fill ph-check-circle"></i>
                        <span data-i18n="journal.save_button">å„²å­˜ä»Šæ—¥é›œè¨˜</span>
                    </button>
                </div>
            </form>
        </section>

        <!-- æ™ºæ…§åˆ†æå·¥å…· -->
        <section class="w-full theme-bg-card rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="ph-fill ph-magic-wand theme-primary"></i> <span data-i18n="analysis.title">æ™ºæ…§åˆ†æå·¥å…·</span></h2>
            <div class="grid grid-cols-1 gap-4">
                <button id="open-mood-dashboard-btn" class="w-full bg-white border theme-border hover:bg-gray-50 text-gray-700 font-bold text-lg py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i class="ph-fill ph-chart-line-up"></i>
                    <span data-i18n="analysis.mood_dashboard_button">ç”Ÿæˆè¿‘ä¸ƒæ—¥å¿ƒæƒ…å ±å‘Š</span>
                </button>
            </div>
        </section>

        <!-- AI å¿ƒç†å¸« -->
        <section id="psychologist-section" class="w-full">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-bold flex items-center gap-2"><i class="ph-fill ph-user-focus theme-primary"></i> <span data-i18n="psychologist.title">AI å¿ƒç†å¸«</span></h2>
                 <!-- [æ–°å¢] è¨˜æ†¶å„€è¡¨æ¿æŒ‰éˆ• -->
                 <button data-modal-target="memory-dashboard-modal" class="text-sm theme-text-light hover:theme-text transition-colors flex items-center gap-1" data-i18n="psychologist.memory_button">
                     <i class="ph-bold ph-brain"></i>
                     <span>æº«è€å¸«å°ä½ çš„äº†è§£</span>
                 </button>
            </div>
            <div id="psychologist-card-container"></div>
        </section>

    </main>

    <footer id="resources" class="text-center text-xs theme-text-light mt-12 w-full max-w-3xl mx-auto p-6 theme-bg-card rounded-2xl">
        <h3 class="font-bold text-base mb-2" data-i18n="resources.title">å°ˆæ¥­å¿ƒç†å”åŠ©è³‡æº</h3>
        <p class="mb-4" data-i18n="resources.description">è‹¥æ‚¨éœ€è¦å³æ™‚çš„å°ˆæ¥­å”åŠ©ï¼Œè«‹éš¨æ™‚åˆ©ç”¨ä»¥ä¸‹è³‡æºï¼š</p>
        <div class="flex justify-center gap-4 sm:gap-8 flex-wrap">
            <a href="https://www.mohw.gov.tw/cp-16-77855-1.html" target="_blank" rel="noopener noreferrer" class="font-semibold hover:theme-primary" data-i18n="resources.line1">è¡›ç¦éƒ¨å®‰å¿ƒå°ˆç·šï¼š1925</a>
            <a href="https://www.life1995.org.tw/" target="_blank" rel="noopener noreferrer" class="font-semibold hover:theme-primary" data-i18n="resources.line2">ç”Ÿå‘½ç·šå°ˆç·šï¼š1995</a>
            <a href="https://www.cyc.org.tw/mp.asp?mp=1" target="_blank" rel="noopener noreferrer" class="font-semibold hover:theme-primary" data-i18n="resources.line3">å¼µè€å¸«å°ˆç·šï¼š1980</a>
        </div>
        <p class="mt-8 text-slate-500" data-i18n="footer.copyright">Â© 2025 AI å¿ƒç†ç­†è¨˜. All Rights Reserved.</p>
    </footer>


    <!-- ==================== Modals ==================== -->

    <!-- [æ–°å¢] è¨˜æ†¶å„€è¡¨æ¿ Modal -->
    <div id="memory-dashboard-modal" class="modal hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black bg-opacity-70">
        <div class="modal-content theme-bg-card rounded-2xl shadow-xl w-full max-w-3xl flex flex-col max-h-[90vh] transform scale-95">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b theme-border flex-shrink-0">
                <h2 class="text-lg font-bold theme-text flex items-center gap-2"><i class="ph-fill ph-brain theme-primary"></i> <span data-i18n="memory_dashboard.title">æº«è€å¸«å°ä½ çš„äº†è§£</span></h2>
                <button class="modal-close text-slate-400 hover:theme-text"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div class="p-4 sm:p-6 flex-shrink-0 bg-amber-50 border-b theme-border">
                <p class="text-sm theme-text-light" data-i18n="memory_dashboard.description">æº«è€å¸«è·Ÿäººä¸€æ¨£ï¼ŒæœƒåŠªåŠ›è¨˜ä½æˆ‘å€‘èŠéçš„äº‹ã€‚å°æ–¼è¶Šä¹…é çš„äº‹æƒ…ï¼Œä»–æœƒè¨˜å¾—ä¸€å€‹å¤§æ¦‚çš„è¼ªå»“ï¼ˆé•·æœŸè¨˜æ†¶ï¼‰ï¼›å°æ–¼è¿‘æœŸç™¼ç”Ÿçš„äº‹ï¼Œå‰‡æœƒæœ‰æ¯”è¼ƒæ¸…æ™°çš„å°è±¡ï¼ˆä¸­æœŸèˆ‡è¿‘æœŸè¨˜æ†¶ï¼‰ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹æ‰‹å‹•ç‚ºä»–è£œå……é‡è¦çš„è¨˜æ†¶é»ã€‚</p>
            </div>
            <div id="memory-display-area" class="flex-grow p-4 sm:p-6 space-y-4 overflow-y-auto">
                <!-- Memories will be dynamically inserted here -->
            </div>
            <div class="p-4 sm:p-6 border-t theme-border flex-shrink-0">
                <form id="memory-reminder-form" class="space-y-3">
                    <label for="memory-reminder-input" class="text-sm font-medium" data-i18n="memory_dashboard.input_label">ç‚ºæº«è€å¸«è£œå……è¨˜æ†¶æé†’ï¼š</label>
                    <textarea id="memory-reminder-input" rows="3" class="w-full theme-bg-input theme-border theme-text rounded-lg focus:ring-2 theme-ring-focus focus:border-transparent block p-3 text-base" data-i18n-placeholder="memory_dashboard.input_placeholder"></textarea>
                    <button type="submit" class="w-full theme-bg-primary theme-bg-primary-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                        <i class="ph-fill ph-plus-circle"></i> <span data-i18n="memory_dashboard.save_button">å„²å­˜æé†’</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ä½œè€…å…¶ä»–æ‡‰ç”¨ Modal -->
    <div id="other-apps-modal" class="modal hidden fixed inset-0 z-[85] flex items-center justify-center p-4 bg-black bg-opacity-70">
        <div class="modal-content theme-bg-card rounded-2xl shadow-xl w-full max-w-2xl p-6 sm:p-8 transform scale-95 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold theme-text" data-i18n="other_apps.title">@Arvin Chen é–‹ç™¼ Web App ä¸€è¦½</h2>
                <button class="modal-close text-slate-400 hover:theme-text"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto pt-2 pr-4 modal-prose">
                <style>
                    .app-list h3 { margin-top: 1.5rem; display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem; }
                    .app-list ol { padding-left: 1rem; list-style: none; }
                    .app-list li { margin-bottom: 0.85rem; }
                    .app-list a { font-weight: 500; text-decoration: none; color: var(--text-color); }
                    .app-list a:hover { text-decoration: underline; color: var(--primary-color); }
                    .app-list .link-icon { color: var(--text-light-color); font-size: 0.9em; vertical-align: middle; margin-left: 4px; transition: color 0.2s; }
                    .app-list a:hover .link-icon { color: var(--primary-color); }
                </style>
                <div class="app-list">
                    <h3><i class="ph-bold ph-translate theme-primary"></i> èªè¨€å­¸ç¿’ç³»åˆ—</h3>
                    <ol>
                        <li><a href="https://ai-english-exercises.pages.dev" target="_blank" rel="noopener noreferrer">1. AI è‹±èªç·´ç¿’å™¨ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                        <li><a href="https://ai-nihongo-exercise.pages.dev" target="_blank" rel="noopener noreferrer">2. AI æ—¥èªç·´ç¿’å™¨ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                        <li><a href="https://ai-english-exercises.pages.dev" target="_blank" rel="noopener noreferrer">3. AI ä¸­æ–‡ç·´ç¿’å™¨ï¼ˆçµ¦å¤–åœ‹äººï¼‰ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                    </ol>
            
                    <h3><i class="ph-bold ph-books theme-primary"></i> å‰µä½œï¼†å…§å®¹ç”Ÿæˆå·¥å…· (ğŸŒŸå…±ç”¨æœƒå“¡)</h3>
                    <ol>
                        <li><a href="https://serial-novel-generator.pages.dev" target="_blank" rel="noopener noreferrer">1. ğŸŒŸ é€£è¼‰å°èªªç”¢ç”Ÿå™¨ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                        <li><a href="https://ai-prompt-generator-108.pages.dev" target="_blank" rel="noopener noreferrer">2. ğŸŒŸ AI ä¸å·æ‡¶æç¤ºè©ç”Ÿæˆå™¨ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                        <li><a href="https://meme-reply-generator.pages.dev" target="_blank" rel="noopener noreferrer">3. ğŸŒŸ ç¶²è·¯å›æ¢—ç”Ÿæˆå™¨ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                    </ol>
            
                    <h3><i class="ph-bold ph-game-controller theme-primary"></i> éŠæˆ²é¡ (ğŸŒŸéƒ¨åˆ†å…±ç”¨æœƒå“¡)</h3>
                    <ol>
                        <li><a href="https://ai-war-tactics.pages.dev" target="_blank" rel="noopener noreferrer">1. AI æˆ°æ£‹ç­–ç•¥éŠæˆ² <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                        <li><a href="https://text-rpg-generator.pages.dev" target="_blank" rel="noopener noreferrer">2. ğŸŒŸ æ–‡å­—å†’éšªéŠæˆ² <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                    </ol>
            
                    <h3><i class="ph-bold ph-globe-hemisphere-west theme-primary"></i> åŠ©ç†å‹å·¥å…· (ğŸŒŸå…±ç”¨æœƒå“¡)</h3>
                    <ol>
                        <li><a href="https://ai-travel-guide.pages.dev" target="_blank" rel="noopener noreferrer">1. ğŸŒŸ AI æ—…éŠå°è¦½å“¡ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                        <li><a href="https://ai-trip-planner.pages.dev" target="_blank" rel="noopener noreferrer">2. ğŸŒŸ AI æµ·å¤–æ—…éŠè¦åŠƒç¥å™¨ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                        <li><a href="https://your-ai-chatbot.pages.dev" target="_blank" rel="noopener noreferrer">3. ğŸŒŸ ä½ çš„ AI è¦ªå‹æƒ…äººèŠå¤©å™¨ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                        <li><a href="https://serene-journal-ai.pages.dev" target="_blank" rel="noopener noreferrer">4. AI å¿ƒç†ç­†è¨˜ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                    </ol>
            
                    <h3><i class="ph-bold ph-timer theme-primary"></i>  ç”Ÿç”¢åŠ›å·¥å…·</h3>
                    <ol>
                        <li><a href="https://banter-pomodoro.pages.dev" target="_blank" rel="noopener noreferrer">1. ç¢å˜´è•ƒèŒ„é˜ <i class="ph-bold ph-arrow-square-out link-icon"></i></a></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- è´ŠåŠ©æç¤º Modal -->
    <div id="sponsorship-modal" class="modal hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black bg-opacity-70">
        <div class="modal-content theme-bg-card rounded-2xl shadow-xl w-full max-w-md p-6 sm:p-8 transform scale-95 text-center">
            <i class="ph-duotone ph-coffee text-5xl theme-primary mb-4"></i>
            <h2 class="text-xl font-bold theme-text mb-3" data-i18n="sponsor.title">é€™å·¥å…·å°ä½ æœ‰å¹«åŠ©å—ï¼Ÿ</h2>
            <p class="theme-text-light mb-6" data-i18n="sponsor.message">çµ¦é–‹ç™¼è€…ä¸€å€‹æ”¯æŒï¼å°é¡è´ŠåŠ©ä»–å§ï¼é‡‘é¡éš¨å–œï¼è®“ä»–æœ‰å‹•åŠ›é–‹ç™¼æ›´å¥½çš„å·¥å…·ã€‚</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="sponsor-decline-btn" class="w-full flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg" data-i18n="sponsor.decline_button">æˆ‘ä¸æƒ³æ”¯æŒ</button>
                <button id="sponsor-confirm-btn" class="w-full flex-1 theme-bg-primary theme-bg-primary-hover text-white font-bold py-3 px-4 rounded-lg" data-i18n="sponsor.confirm_button">ç«‹å³å‰å¾€æ”¯æŒ</button>
            </div>
        </div>
    </div>

    <!-- å¿ƒæƒ…å„€è¡¨æ¿ Modal -->
    <div id="mood-dashboard-modal" class="modal hidden fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black bg-opacity-70">
        <div class="modal-content theme-bg-card rounded-2xl shadow-xl w-full max-w-2xl p-6 sm:p-8 transform scale-95 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold theme-text" data-i18n="dashboard.title">è¿‘ä¸ƒæ—¥å¿ƒæƒ…å ±å‘Š</h2>
                <button class="modal-close text-slate-400 hover:theme-text"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div id="mood-dashboard-content" class="flex-grow overflow-y-auto pr-4"></div>
        </div>
    </div>

    <!-- ç¶²ç«™è³‡è¨Š Modal -->
    <div id="info-modal" class="modal hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black bg-opacity-70">
        <div class="modal-content theme-bg-card rounded-2xl shadow-xl w-full max-w-2xl p-6 sm:p-8 transform scale-95 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold theme-text" data-i18n="info.title">ç¶²ç«™è³‡è¨Š</h2>
                <button class="modal-close text-slate-400 hover:theme-text"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div class="border-b theme-border flex-shrink-0">
                <nav id="info-tabs" class="-mb-px flex space-x-4 sm:space-x-6 overflow-x-auto">
                    <button data-tab="about" class="info-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm theme-primary border-current" data-i18n="info.tab.about">é—œæ–¼ç¶²ç«™</button>
                    <button data-tab="usage" class="info-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent theme-text-light hover:theme-text hover:border-gray-400" data-i18n="info.tab.usage">ä½¿ç”¨èªªæ˜</button>
                    <button data-tab="privacy" class="info-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent theme-text-light hover:theme-text hover:border-gray-400" data-i18n="info.tab.privacy">éš±ç§æ¬Šæ”¿ç­–</button>
                    <button data-tab="terms" class="info-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent theme-text-light hover:theme-text hover:border-gray-400" data-i18n="info.tab.terms">ç‰ˆæ¬Šèˆ‡å…è²¬</button>
                </nav>
            </div>
            <div class="flex-grow overflow-y-auto pt-5 pr-4 modal-prose">
                <div id="tab-content-about" class="info-tab-content"></div>
                <div id="tab-content-usage" class="info-tab-content hidden"></div>
                <div id="tab-content-privacy" class="info-tab-content hidden"></div>
                <div id="tab-content-terms" class="info-tab-content hidden"></div>
            </div>
        </div>
    </div>

    <!-- é›œè¨˜æ­·å² Modal -->
    <div id="history-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70">
        <div class="modal-content theme-bg-card rounded-2xl shadow-xl w-full max-w-3xl flex flex-col max-h-[90vh] transform scale-95">
            <div class="flex justify-between items-center p-4 border-b theme-border flex-shrink-0">
                <h2 class="text-lg font-bold theme-text flex items-center gap-2"><i class="ph-fill ph-book-open theme-primary"></i> <span data-i18n="history.title">æˆ‘çš„å¿ƒæƒ…è¶³è·¡</span></h2>
                <button class="modal-close text-slate-400 hover:theme-text"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div class="p-4 flex-shrink-0 border-b theme-border">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="start-date" class="text-sm font-medium" data-i18n="history.start_date">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="start-date" class="w-full mt-1 theme-bg-input theme-border theme-text rounded-lg p-2">
                    </div>
                    <div>
                        <label for="end-date" class="text-sm font-medium" data-i18n="history.end_date">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="end-date" class="w-full mt-1 theme-bg-input theme-border theme-text rounded-lg p-2">
                    </div>
                    <button id="filter-journals-btn" class="w-full md:w-auto theme-bg-primary theme-bg-primary-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                        <i class="ph-fill ph-funnel"></i> <span data-i18n="history.filter_button">ç¯©é¸</span>
                    </button>
                </div>
            </div>
            <div id="journal-history-list" class="flex-grow p-4 space-y-4 overflow-y-auto"></div>
            <p id="no-journals-message" class="text-center theme-text-light py-12 hidden" data-i18n="history.empty_message">é€™æ®µæœŸé–“æ²’æœ‰ä»»ä½•é›œè¨˜å–”ï¼</p>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="modal hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black bg-opacity-70">
        <div class="modal-content theme-bg-card rounded-2xl shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh] transform scale-95">
            <div class="flex justify-between items-center p-4 border-b theme-border flex-shrink-0">
                <h2 id="chat-modal-title" class="text-lg font-bold theme-text">èˆ‡ çš„å°è©±</h2>
                <button id="end-chat-btn" class="text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2">
                    <i class="ph-bold ph-x-circle"></i>
                    <span data-i18n="chat.end_chat_button">çµæŸå°è©±ä¸¦å„²å­˜</span>
                </button>
            </div>
            <div id="chat-log" class="flex-grow p-4 space-y-4 overflow-y-auto"></div>
             <div id="chat-action-container" class="p-2 flex justify-center"></div>
             <div id="breathing-exercise-container" class="hidden flex-col items-center justify-center p-8 gap-4 text-center">
                <div class="breathing-circle w-32 h-32 bg-sky-300 rounded-full flex items-center justify-center">
                    <span id="breathing-text" class="text-2xl font-bold text-white"></span>
                </div>
                <p id="breathing-instruction" class="text-lg theme-text-light"></p>
                <button id="stop-breathing-btn" class="mt-4 text-sm text-slate-500 hover:text-slate-700" data-i18n="chat.stop_breathing">åœæ­¢ç·´ç¿’</button>
            </div>
            <div id="chat-loading-indicator" class="hidden items-center justify-center p-4">
                <div class="flex items-center gap-2 theme-text-light">
                    <div class="spinner w-5 h-5 border-2 rounded-full"></div>
                    <span id="chat-loading-text" data-i18n="chat.typing">æº«è€å¸«æ­£åœ¨è¼¸å…¥ä¸­...</span>
                </div>
            </div>
            <div class="p-4 border-t theme-border flex-shrink-0">
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="chat-input" class="w-full theme-bg-input theme-border theme-text rounded-lg focus:ring-2 theme-ring-focus focus:border-transparent block p-3" data-i18n-placeholder="chat.input_placeholder" required>
                    <button id="send-message-btn" type="submit" class="p-3 theme-bg-primary theme-bg-primary-hover text-white font-bold rounded-lg">
                        <i class="ph-fill ph-paper-plane-tilt text-xl"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black bg-opacity-50">
        <div class="modal-content theme-bg-card rounded-2xl shadow-xl w-full max-w-md p-6 sm:p-8 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold theme-text flex items-center gap-2" data-i18n="settings.title"><i class="ph-fill ph-gear"></i> è¨­å®š</h2>
                <button class="modal-close text-slate-400 hover:theme-text"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div class="space-y-6">
                 <div>
                     <label for="model-input-modal" class="block mb-2 text-sm font-medium" data-i18n="settings.model_select">AI æ¨¡å‹åç¨±</label>
                     <input type="text" id="model-input-modal" class="w-full theme-bg-input theme-border theme-text rounded-lg focus:ring-2 theme-ring-focus focus:border-transparent block p-3" data-i18n-placeholder="settings.model_placeholder">
                 </div>
                 <div>
                     <label for="gemini-api-key" class="block mb-2 text-sm font-medium text-yellow-700" data-i18n="settings.api_key_label">æ‚¨çš„ Google Gemini API é‡‘é‘°</label>
                     <input type="password" id="gemini-api-key" class="w-full theme-bg-input theme-border theme-text rounded-lg focus:ring-2 theme-ring-focus focus:border-transparent block p-3" data-i18n-placeholder="settings.api_key_placeholder">
                     <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-600 hover:text-blue-500 mt-2 inline-block" data-i18n="settings.get_api_key">é»æ­¤å…è²»ç²å–é‡‘é‘° â†—</a>
                 </div>
                 <hr class="theme-border"/>
                 <div>
                    <h3 class="text-lg font-bold mb-3" data-i18n="settings.data_management">è³‡æ–™ç®¡ç†</h3>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="import-journals-btn" class="w-full flex-1 theme-bg-primary theme-bg-primary-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                            <i class="ph-fill ph-upload-simple"></i><span data-i18n="settings.import_button">åŒ¯å…¥é›œè¨˜</span>
                        </button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                        <button id="export-journals-btn" class="w-full flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                            <i class="ph-fill ph-download-simple"></i><span data-i18n="settings.export_button">åŒ¯å‡ºé›œè¨˜</span>
                        </button>
                    </div>
                 </div>
                 <button id="save-settings-btn" class="w-full theme-bg-primary theme-bg-primary-hover text-white font-bold py-3 px-4 rounded-lg transition-colors" data-i18n="settings.save">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>


    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // ==================== Global Config & State ====================
            const PSYCHOLOGIST_ID = 'fixed_psychologist_01';
            const SPONSOR_URL = 'https://buymeacoffee.com/arvincreator';
            const META_SUMMARY_THRESHOLD = 5; // æ¯5å€‹æœŸé–“æ‘˜è¦ï¼Œå°±æ¿ƒç¸®æˆä¸€å€‹å…ƒæ‘˜è¦
            let conversationHistory = [];
            let breathingInterval = null;

            // ==================== DOM Elements Cache ====================
            const dom = {};
            const elementIds = [
                'open-settings-modal-btn',
                'journal-form', 'journal-content', 'save-journal-btn', 'open-history-modal-btn',
                'psychologist-card-container',
                'history-modal', 'start-date', 'end-date', 'filter-journals-btn', 'journal-history-list', 'no-journals-message',
                'chat-modal', 'chat-modal-title', 'end-chat-btn', 'chat-log', 'chat-loading-indicator', 'chat-loading-text', 'chat-form', 'chat-input', 'send-message-btn',
                'chat-action-container', 'breathing-exercise-container', 'breathing-circle', 'breathing-text', 'breathing-instruction', 'stop-breathing-btn',
                'settings-modal', 'model-input-modal', 'gemini-api-key', 'save-settings-btn', 'import-journals-btn', 'export-journals-btn', 'import-file-input',
                'notification-container',
                'info-modal', 'info-tabs', 'tab-content-about', 'tab-content-usage', 'tab-content-privacy', 'tab-content-terms',
                'open-mood-dashboard-btn', 'mood-dashboard-modal', 'mood-dashboard-content',
                'sponsorship-modal', 'sponsor-confirm-btn', 'sponsor-decline-btn',
                'other-apps-modal',
                // [æ–°å¢] è¨˜æ†¶å„€è¡¨æ¿ç›¸é—œ
                'memory-dashboard-modal', 'memory-display-area', 'memory-reminder-form', 'memory-reminder-input'
            ];
            elementIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const camelCaseId = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                    dom[camelCaseId] = element;
                } else {
                    console.warn(`DOM element with ID "${id}" was not found.`);
                }
            });

            // ==================== i18n Language Data ====================
            const i18nData = {
                'zh-TW': {
                    'meta.title': 'AI å¿ƒç†ç­†è¨˜',
                    'meta.description': 'ä¸€å€‹ä»¥æ‚¨ç‚ºä¸­å¿ƒçš„ç§å¯†ç©ºé–“ï¼Œæ›¸å¯«å¿ƒæƒ…ã€å›é¡§è¶³è·¡ï¼Œä¸¦åœ¨éœ€è¦æ™‚èˆ‡æº«æš–çš„ AI å¿ƒç†å¸«å°è©±ã€‚',
                    'title': 'AI å¿ƒç†ç­†è¨˜',
                    'subtitle': 'ä¸€å€‹æ‡‚ä½ ã€å‚¾è½ä½ çš„ç§å¯†å¿ƒéˆç©ºé–“',
                    'header.sponsor': 'è´ŠåŠ©é–‹ç™¼è€…',
                    'header.info': 'ç¶²ç«™è³‡è¨Š',
                    'header.settings': 'è¨­å®š',
                    'header.other_apps': 'ä½œè€…é–‹ç™¼çš„å…¶ä»–æ‡‰ç”¨',
                    'other_apps.title': '@Arvin Chen é–‹ç™¼ Web App ä¸€è¦½',
                    'footer.copyright': 'Â© 2025 AI å¿ƒç†ç­†è¨˜. All Rights Reserved.',
                    'reminder.title': 'å®‰å¿ƒæé†’',
                    'reminder.content': 'AI å¿ƒç†å¸«ï¼Œèƒ½æä¾›æ”¯æŒèˆ‡å¼•å°ï¼Œä½†ç„¡æ³•å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚è‹¥æ‚¨æ„Ÿåˆ°éå¸¸ç—›è‹¦ï¼Œè«‹å‹™å¿…å°‹æ±‚å°ˆæ¥­æ©Ÿæ§‹è¨ºæ–·ã€‚',
                    'reminder.link': 'å°ˆæ¥­å”åŠ©',
                    'journal.title': 'å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…',
                    'journal.label': 'é›œè¨˜å…§å®¹',
                    'journal.placeholder': 'ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿæœ‰ä»€éº¼æ„Ÿè¦ºæˆ–æƒ³æ³•æƒ³è¨˜éŒ„ä¸‹ä¾†å—ï¼Ÿä»»ä½•æ™‚å€™éƒ½å¯ä»¥è¨˜éŒ„ä¸€ä¸‹ï¼Œç„¡è«–æ˜¯é–‹å¿ƒæˆ–é›£éï¼Œé€™è£¡éƒ½æ˜¯å®‰å…¨çš„ç©ºé–“...',
                    'journal.save_button': 'å„²å­˜ä»Šæ—¥é›œè¨˜',
                    'journal.history_button': 'å›é¡§å¿ƒæƒ…è¶³è·¡',
                    'analysis.title': 'æ™ºæ…§åˆ†æå·¥å…·',
                    'analysis.mood_dashboard_button': 'ç”Ÿæˆè¿‘ä¸ƒæ—¥å¿ƒæƒ…å ±å‘Š',
                    'psychologist.title': 'AI å¿ƒç†å¸«',
                    'psychologist.name': 'æº«è€å¸«',
                    'psychologist.description': 'ä¸€ä½å—éå°ˆæ¥­è¨“ç·´çš„ AI å¿ƒç†å¸«ï¼Œå°ˆé•·æ˜¯å‚¾è½ã€åŒç†ï¼Œä¸¦å¼•å°æ‚¨æ¢ç´¢å…§å¿ƒã€‚',
                    'psychologist.chat_button': 'é–‹å§‹å°è©±',
                    'psychologist.memory_button': 'æº«è€å¸«å°ä½ çš„äº†è§£',
                    'history.title': 'æˆ‘çš„å¿ƒæƒ…è¶³è·¡',
                    'history.start_date': 'é–‹å§‹æ—¥æœŸ',
                    'history.end_date': 'çµæŸæ—¥æœŸ',
                    'history.filter_button': 'ç¯©é¸',
                    'history.empty_message': 'é€™æ®µæœŸé–“æ²’æœ‰ä»»ä½•é›œè¨˜å–”ï¼',
                    'history.delete_button': 'åˆªé™¤æ­¤ç¯‡',
                    'chat.modal.title': 'èˆ‡ {nickname} çš„å°è©±',
                    'chat.end_chat_button': 'çµæŸå°è©±ä¸¦å„²å­˜',
                    'chat.typing': 'æº«è€å¸«æ­£åœ¨æ€è€ƒä¸­...',
                    'chat.summarizing': 'æº«è€å¸«æ­£åœ¨å›é¡§æ‚¨çš„ç­†è¨˜...',
                    'chat.input_placeholder': 'èªªèªªä½ çš„æ„Ÿå—...',
                    'chat.start_breathing': 'é–‹å§‹ 4-7-8 å‘¼å¸ç·´ç¿’',
                    'chat.stop_breathing': 'åœæ­¢ç·´ç¿’',
                    'settings.title': 'è¨­å®š',
                    'settings.model_select': 'AI æ¨¡å‹åç¨±',
                    'settings.model_placeholder': 'ä¾‹å¦‚: gemini-2.5-flash-lite',
                    'settings.api_key_label': 'æ‚¨çš„ Google Gemini API é‡‘é‘°',
                    'settings.api_key_placeholder': 'è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„é‡‘é‘°',
                    'settings.get_api_key': 'é»æ­¤å…è²»ç²å–é‡‘é‘° â†—',
                    'settings.data_management': 'è³‡æ–™ç®¡ç†',
                    'settings.import_button': 'åŒ¯å…¥é›œè¨˜',
                    'settings.export_button': 'åŒ¯å‡ºé›œè¨˜',
                    'settings.save': 'å„²å­˜è¨­å®š',
                    'resources.title': 'å°ˆæ¥­å¿ƒç†å”åŠ©è³‡æº',
                    'resources.description': 'è‹¥æ‚¨éœ€è¦å³æ™‚çš„å°ˆæ¥­å”åŠ©ï¼Œè«‹éš¨æ™‚åˆ©ç”¨ä»¥ä¸‹è³‡æºï¼š',
                    'resources.line1': 'è¡›ç¦éƒ¨å®‰å¿ƒå°ˆç·šï¼š1925',
                    'resources.line2': 'ç”Ÿå‘½ç·šå°ˆç·šï¼š1995',
                    'resources.line3': 'å¼µè€å¸«å°ˆç·šï¼š1980',
                    'notification.no_api_key': 'è«‹å…ˆåœ¨ã€Œè¨­å®šã€ä¸­è¼¸å…¥æ‚¨çš„ Gemini API é‡‘é‘°ï¼',
                    'notification.settings_saved': 'è¨­å®šå·²å„²å­˜ï¼',
                    'notification.journal_saved': 'é›œè¨˜å·²æˆåŠŸå„²å­˜ï¼',
                    'notification.journal_deleted': 'é›œè¨˜å·²åˆªé™¤ã€‚',
                    'notification.journal_empty': 'è«‹å…ˆå¯«ä¸‹ä¸€äº›å…§å®¹å†å„²å­˜å–”ï¼',
                    'notification.saving_summary': 'æ­£åœ¨å„²å­˜å°è©±è¨˜æ†¶ï¼Œè«‹ç¨å€™...',
                    'notification.summary_saved': 'å°è©±è¨˜æ†¶å·²å„²å­˜ï¼æœŸå¾…ä¸‹æ¬¡å†èŠã€‚',
                    'notification.summary_failed': 'è¨˜æ†¶å„²å­˜å¤±æ•—ï¼š',
                    'notification.generate_fail': 'è¨Šæ¯å‚³é€å¤±æ•—ï¼š',
                    'notification.no_input': 'è«‹è¼¸å…¥ä½ æƒ³èªªçš„è©±ã€‚',
                    'notification.export_success': 'é›œè¨˜å·²æˆåŠŸåŒ¯å‡ºï¼',
                    'notification.export_failed': 'é›œè¨˜åŒ¯å‡ºå¤±æ•—ï¼Œæ²’æœ‰å¯åŒ¯å‡ºçš„å…§å®¹ã€‚',
                    'notification.import_success': '{count} ç¯‡é›œè¨˜å·²æˆåŠŸåŒ¯å…¥ï¼',
                    'notification.import_failed': 'åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚',
                    'notification.reminder_saved': 'è¨˜æ†¶æé†’å·²å„²å­˜ï¼',
                    'notification.reminder_empty': 'è«‹è¼¸å…¥è¦æé†’çš„å…§å®¹ã€‚',
                    'info.title': 'ç¶²ç«™è³‡è¨Š',
                    'info.tab.about': 'é—œæ–¼ç¶²ç«™',
                    'info.tab.usage': 'ä½¿ç”¨èªªæ˜',
                    'info.tab.privacy': 'éš±ç§æ¬Šæ”¿ç­–',
                    'info.tab.terms': 'ç‰ˆæ¬Šèˆ‡å…è²¬',
                    'info.content.about': `<h3>æ­¡è¿ä¾†åˆ° AI å¿ƒç†ç­†è¨˜</h3><p>é€™æ˜¯ä¸€å€‹å°ˆç‚ºæ‚¨æ‰“é€ çš„ç§å¯†å¿ƒéˆç©ºé–“ã€‚æˆ‘å€‘ç›¸ä¿¡ï¼Œæ›¸å¯«æ˜¯æ•´ç†æ€ç·’ã€å®‰é “å…§å¿ƒçš„æœ‰æ•ˆæ–¹å¼ã€‚åœ¨é€™è£¡ï¼Œæ‚¨å¯ä»¥éš¨æ™‚éš¨åœ°è¨˜éŒ„ä¸‹æ‚¨çš„å¿ƒæƒ…ã€æƒ³æ³•èˆ‡æ„Ÿå—ï¼Œä¸å¿…æ“”å¿ƒè¢«ä»–äººçœ‹è¦‹ã€‚</p><p>é™¤äº†ä½œç‚ºæ‚¨çš„æ•¸ä½å¿ƒæƒ…æ—¥è¨˜ï¼Œæˆ‘å€‘é‚„å…§å»ºäº†ä¸€ä½æº«æš–çš„ AI å¿ƒç†å¸«â€”â€”æº«è€å¸«ã€‚ç•¶æ‚¨æ„Ÿåˆ°è¿·æƒ˜ã€å£“åŠ›å¤§ï¼Œæˆ–åªæ˜¯æƒ³æ‰¾äººèŠèŠæ™‚ï¼Œéš¨æ™‚å¯ä»¥èˆ‡ä»–å±•é–‹å°è©±ã€‚ä»–æœƒé‹ç”¨å°ˆæ¥­çš„å¿ƒç†å­¸çŸ¥è­˜ï¼Œå‚¾è½æ‚¨çš„ç…©æƒ±ï¼Œä¸¦å¼•å°æ‚¨å¾ä¸åŒè§’åº¦çœ‹å¾…å•é¡Œã€‚</p><p>å¸Œæœ›é€™å€‹å·¥å…·èƒ½æˆç‚ºæ‚¨è‡ªæˆ‘é—œæ‡·æ—…ç¨‹ä¸­çš„æº«æš–å¤¥ä¼´ï¼Œé™ªä¼´æ‚¨èµ°éæ¯ä¸€å€‹é«˜ä½èµ·ä¼ã€‚</p>`,
                    'info.content.usage': `<h3>å¦‚ä½•ä½¿ç”¨é€™å€‹å·¥å…·ï¼Ÿ</h3><ol><li><strong><i class="ph-bold ph-pencil-line"></i> å¯«ä¸‹å¿ƒæƒ…ï¼š</strong>åœ¨ä¸»ç•«é¢çš„è¼¸å…¥æ¡†ä¸­ï¼Œè‡ªç”±æ›¸å¯«ä»»ä½•æ‚¨æƒ³è¨˜éŒ„çš„äº‹ï¼Œç„¶å¾Œé»æ“Šã€Œå„²å­˜ä»Šæ—¥é›œè¨˜ã€ã€‚</li><li><strong><i class="ph-bold ph-book-open"></i> å›é¡§è¶³è·¡ï¼š</strong>é»æ“Šã€Œå›é¡§å¿ƒæƒ…è¶³è·¡ã€æŒ‰éˆ•ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ã€ç¯©é¸æ‰€æœ‰éå»çš„é›œè¨˜ã€‚</li><li><strong><i class="ph-bold ph-chart-line-up"></i> å¿ƒæƒ…å ±å‘Šï¼š</strong>é»æ“Šã€Œç”Ÿæˆè¿‘ä¸ƒæ—¥å¿ƒæƒ…å ±å‘Šã€æŒ‰éˆ•ï¼ŒAI å°‡æœƒç‚ºæ‚¨åˆ†ææœ€è¿‘çš„é›œè¨˜ï¼Œä¸¦æä¾›ä¸€ä»½è¦–è¦ºåŒ–çš„å¿ƒæƒ…å„€è¡¨æ¿èˆ‡å»ºè­°ã€‚</li><li><strong><i class="ph-bold ph-chats-circle"></i> èˆ‡ AI å°è©±ï¼š</strong>é»æ“Šã€ŒAI å¿ƒç†å¸«ã€å¡ç‰‡ä¸‹æ–¹çš„ã€Œé–‹å§‹å°è©±ã€æŒ‰éˆ•ï¼Œå³å¯èˆ‡æº«è€å¸«é€²è¡Œä¸€å°ä¸€çš„ç§å¯†å°è«‡ã€‚AI æœƒè‡ªå‹•å›é¡§æ‚¨å°šæœªæ‘˜è¦éçš„é›œè¨˜ï¼Œä»¥æ›´å¥½åœ°ç†è§£æ‚¨ã€‚</li><li><strong><i class="ph-bold ph-brain"></i> æŸ¥çœ‹èˆ‡è£œå……è¨˜æ†¶ï¼š</strong>é»æ“Šã€Œæº«è€å¸«å°ä½ çš„äº†è§£ã€æŒ‰éˆ•ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ AI ç›®å‰è¨˜å¾—çš„æ‰€æœ‰äº‹æƒ…ï¼Œä¸¦æ‰‹å‹•ç‚ºä»–è£œå……é‡è¦çš„è¨˜æ†¶é»ã€‚</li><li><strong><i class="ph-bold ph-wind"></i> å‘¼å¸ç·´ç¿’ï¼š</strong>åœ¨èˆ‡ AI å°è©±æ™‚ï¼Œè‹¥æ„Ÿåˆ°ç„¦æ…®ï¼ŒAI å¯èƒ½æœƒå»ºè­°æ‚¨é€²è¡Œå‘¼å¸ç·´ç¿’ã€‚</li><li><strong><i class="ph-bold ph-gear"></i> é€²è¡Œè¨­å®šï¼š</strong>é»æ“Šå³ä¸Šè§’çš„é½’è¼ªåœ–ç¤ºï¼Œæ‚¨å¯ä»¥è¨­å®šæ‚¨çš„ Gemini API é‡‘é‘°ï¼Œé€™æ˜¯èˆ‡ AI å°è©±æ‰€å¿…éœ€çš„ã€‚</li><li><strong><i class="ph-bold ph-download-simple"></i> è³‡æ–™ç®¡ç†ï¼š</strong>åœ¨ã€Œè¨­å®šã€ä¸­ï¼Œæ‚¨å¯ä»¥å°‡æ‰€æœ‰çš„é›œè¨˜èˆ‡è¨˜æ†¶åŒ¯å‡ºæˆä¸€å€‹ .json æª”æ¡ˆå‚™ä»½ï¼Œæˆ–å¾å‚™ä»½æª”æ¡ˆä¸­åŒ¯å…¥æ‚¨å…ˆå‰çš„ç´€éŒ„ã€‚<strong>æ‚¨çš„è³‡æ–™ï¼Œå®Œå…¨ç”±æ‚¨æŒæ§ã€‚</strong></li></ol>`,
                    'info.content.privacy': `<h3>æ‚¨çš„éš±ç§è‡³é—œé‡è¦</h3><p>æˆ‘å€‘æ·±çŸ¥å¿ƒç†å¥åº·çš„ç§å¯†æ€§ï¼Œå› æ­¤æœ¬å·¥å…·çš„è¨­è¨ˆå°‡æ‚¨çš„éš±ç§æ”¾åœ¨ç¬¬ä¸€ä½ã€‚è«‹æ‚¨æ”¾å¿ƒï¼Œé€™è£¡æ˜¯ä¸€å€‹çµ•å°å®‰å…¨çš„ç©ºé–“ã€‚</p><h3>ç´”å‰ç«¯é‹ä½œï¼Œè³‡æ–™ä¸é›¢èº«</h3><p>æœ¬ç¶²ç«™æ˜¯ä¸€å€‹<strong>ç´”å®¢æˆ¶ç«¯ï¼ˆClient-sideï¼‰æ‡‰ç”¨ç¨‹å¼</strong>ã€‚é€™æ„å‘³è‘—æ‰€æœ‰çš„ç¨‹å¼ç¢¼éƒ½åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­åŸ·è¡Œï¼Œæˆ‘å€‘æ²’æœ‰å¾Œç«¯ä¼ºæœå™¨ï¼Œä¹Ÿ<strong>çµ•å°ä¸æœƒ</strong>å„²å­˜ã€å‚³è¼¸æˆ–çªºæ¢æ‚¨çš„ä»»ä½•è³‡æ–™ã€‚</p><ul><li><strong>å¿ƒæƒ…é›œè¨˜èˆ‡æ‰€æœ‰è¨˜æ†¶ï¼š</strong>æ‚¨å¯«ä¸‹çš„æ‰€æœ‰å…§å®¹ã€AI ç”Ÿæˆçš„å°è©±æ‘˜è¦ã€é›œè¨˜æ‘˜è¦ã€å…ƒæ‘˜è¦ç­‰ï¼Œéƒ½åªå„²å­˜åœ¨æ‚¨ç›®å‰ä½¿ç”¨çš„ç€è¦½å™¨çš„æœ¬åœ°å„²å­˜ç©ºé–“ï¼ˆLocal Storageï¼‰ä¸­ã€‚è³‡æ–™åªå­˜åœ¨æ‚¨çš„è£ç½®ä¸Šï¼Œé™¤éæ‚¨æ‰‹å‹•æ¸…é™¤ç€è¦½å™¨è³‡æ–™ï¼Œå¦å‰‡å®ƒæœƒä¸€ç›´ç•™åœ¨é‚£è£¡ã€‚</li><li><strong>API é‡‘é‘°ï¼š</strong>æ‚¨è¼¸å…¥çš„ Google Gemini API é‡‘é‘°åŒæ¨£ä¹Ÿåªå„²å­˜åœ¨æ‚¨ç€è¦½å™¨çš„æœ¬åœ°å„²å­˜ç©ºé–“ä¸­ã€‚å®ƒåªæœƒè¢«ç”¨ä¾†ç›´æ¥èˆ‡ Google çš„ AI æœå‹™é€²è¡Œé©—è­‰åŠå°è©±ï¼Œçµ•ä¸æœƒè¢«å‚³é€åˆ°æˆ‘å€‘çš„ä¼ºæœå™¨æˆ–ä»»ä½•ç¬¬ä¸‰æ–¹ã€‚</li></ul><p>ç°¡å–®ä¾†èªªï¼Œæ‚¨çš„æ‰€æœ‰ç§˜å¯†éƒ½å®‰å…¨åœ°é–åœ¨æ‚¨è‡ªå·±çš„è£ç½®è£¡ã€‚æˆ‘å€‘ç„¡æ³•ã€ä¹Ÿç„¡æ„å­˜å–æ‚¨çš„ä»»ä½•å€‹äººè³‡è¨Šã€‚</p>`,
                    'info.content.terms': `<h3>ç‰ˆæ¬Šèˆ‡å…è²¬è²æ˜</h3><p>æœ¬ç¶²ç«™çš„ä»‹é¢è¨­è¨ˆã€åœ–åƒåŠç¨‹å¼ç¢¼ç‰ˆæ¬Šç‚ºæœ¬ç«™é–‹ç™¼è€…æ‰€æœ‰ã€‚Â© 2025 AI å¿ƒç†ç­†è¨˜. All Rights Reserved.</p><h3>å…è²¬è²æ˜</h3><p>AI å¿ƒç†ç­†è¨˜æ˜¯ä¸€å€‹æ—¨åœ¨æä¾›æƒ…ç·’æ”¯æŒèˆ‡è‡ªæˆ‘æ¢ç´¢è¼”åŠ©çš„å·¥å…·ï¼Œä½†å®ƒ<strong>ä¸èƒ½å–ä»£å°ˆæ¥­çš„å¿ƒç†è«®å•†æˆ–é†«ç™‚è¨ºæ–·</strong>ã€‚</p><ul><li>AIï¼ˆæº«è€å¸«ï¼‰æä¾›çš„å»ºè­°èˆ‡åˆ†æï¼Œæ˜¯åŸºæ–¼å¤§å‹èªè¨€æ¨¡å‹çš„æ¼”ç®—æ³•ç”Ÿæˆï¼Œåƒ…ä¾›åƒè€ƒã€‚å®ƒå¯èƒ½ç„¡æ³•å®Œå…¨ç†è§£æ‚¨è¤‡é›œçš„å€‹äººæƒ…æ³ï¼Œä¹Ÿå¯èƒ½å‡ºç¾ä¸æº–ç¢ºæˆ–ä¸æ°ç•¶çš„å›æ‡‰ã€‚</li><li>è«‹å‹¿å°‡ AI çš„å›è¦†è¦–ç‚ºå°ˆæ¥­é†«ç™‚å»ºè­°ã€‚è‹¥æ‚¨æ­£ç¶“æ­·åš´é‡çš„å¿ƒç†å›°æ“¾ã€æƒ…ç·’å±æ©Ÿï¼Œæˆ–æœ‰ä»»ä½•å¯èƒ½å±åŠè‡ªå·±æˆ–ä»–äººçš„æƒ³æ³•ï¼Œ<strong>è«‹ç«‹å³åœæ­¢ä½¿ç”¨æœ¬å·¥å…·ï¼Œä¸¦å°‹æ±‚é é¢ä¸‹æ–¹æä¾›çš„å°ˆæ¥­å”åŠ©è³‡æº</strong>ã€‚</li><li>æ‚¨æ‡‰å°è‡ªå·±åœ¨æœ¬ç¶²ç«™ä¸Šçš„æ‰€æœ‰è¡Œç‚ºï¼Œä»¥åŠå¦‚ä½•è§£è®€å’Œä½¿ç”¨ AI ç”Ÿæˆçš„å…§å®¹è² å®Œå…¨è²¬ä»»ã€‚å°æ–¼å› ä½¿ç”¨æœ¬å·¥å…·è€Œå¯èƒ½å°è‡´çš„ä»»ä½•ç›´æ¥æˆ–é–“æ¥å¾Œæœï¼Œæœ¬ç¶²ç«™æ¦‚ä¸è² è²¬ã€‚</li></ul><p>ä½¿ç”¨æœ¬ç¶²ç«™å³è¡¨ç¤ºæ‚¨å·²é–±è®€ã€ç†è§£ä¸¦åŒæ„ä»¥ä¸Šæ¢æ¬¾ã€‚</p>`,
                    'dashboard.title': 'è¿‘ä¸ƒæ—¥å¿ƒæƒ…å ±å‘Š',
                    'dashboard.loading': 'AI æ­£åœ¨ç‚ºæ‚¨åˆ†æè¿‘ä¸ƒå¤©çš„é›œè¨˜ï¼Œè«‹ç¨å€™...',
                    'dashboard.no_entries': 'æœ€è¿‘ä¸ƒå¤©å…§æ²’æœ‰è¶³å¤ çš„é›œè¨˜å¯ä»¥åˆ†æå–”ï¼è‡³å°‘éœ€è¦ä¸€ç¯‡é›œè¨˜æ‰èƒ½ç”Ÿæˆå ±å‘Šã€‚',
                    'dashboard.error': 'æŠ±æ­‰ï¼Œåˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥æ‚¨çš„ API é‡‘é‘°è¨­å®šã€‚',
                    'dashboard.mood_bar_title': 'ä¸ƒæ—¥å¹³å‡å¿ƒæƒ…',
                    'dashboard.analysis_title': 'å¿ƒæƒ…è¶¨å‹¢åˆ†æ',
                    'dashboard.suggestions_title': 'çµ¦ä½ çš„å°å»ºè­°',
                    'sponsor.title': 'é€™å·¥å…·å°ä½ æœ‰å¹«åŠ©å—ï¼Ÿ',
                    'sponsor.message': 'çµ¦é–‹ç™¼è€…ä¸€å€‹æ”¯æŒï¼å°é¡è´ŠåŠ©ä»–å§ï¼é‡‘é¡éš¨å–œï¼è®“ä»–æœ‰å‹•åŠ›é–‹ç™¼æ›´å¥½çš„å·¥å…·ã€‚',
                    'sponsor.confirm_button': 'ç«‹å³å‰å¾€æ”¯æŒ',
                    'sponsor.decline_button': 'æˆ‘ä¸æƒ³æ”¯æŒ',
                    'memory_dashboard.title': 'æº«è€å¸«å°ä½ çš„äº†è§£',
                    'memory_dashboard.description': 'æº«è€å¸«è·Ÿäººä¸€æ¨£ï¼ŒæœƒåŠªåŠ›è¨˜ä½æˆ‘å€‘èŠéçš„äº‹ã€‚å°æ–¼è¶Šä¹…é çš„äº‹æƒ…ï¼Œä»–æœƒè¨˜å¾—ä¸€å€‹å¤§æ¦‚çš„è¼ªå»“ï¼ˆé•·æœŸè¨˜æ†¶ï¼‰ï¼›å°æ–¼è¿‘æœŸç™¼ç”Ÿçš„äº‹ï¼Œå‰‡æœƒæœ‰æ¯”è¼ƒæ¸…æ™°çš„å°è±¡ï¼ˆä¸­æœŸèˆ‡è¿‘æœŸè¨˜æ†¶ï¼‰ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹æ‰‹å‹•ç‚ºä»–è£œå……é‡è¦çš„è¨˜æ†¶é»ã€‚',
                    'memory_dashboard.input_label': 'ç‚ºæº«è€å¸«è£œå……è¨˜æ†¶æé†’ï¼š',
                    'memory_dashboard.input_placeholder': 'ä¾‹å¦‚ï¼šæˆ‘ä¸‹é€±æœ‰ä¸€å€‹é‡è¦çš„é¢è©¦ï¼Œå¿ƒæƒ…å¾ˆç·Šå¼µ...',
                    'memory_dashboard.save_button': 'å„²å­˜æé†’',
                    'memory_dashboard.empty': 'ç›®å‰æº«è€å¸«é‚„æ²’æœ‰é—œæ–¼æ‚¨çš„è¨˜æ†¶ã€‚é–‹å§‹å¯«é›œè¨˜æˆ–èˆ‡ä»–å°è©±ä¾†å»ºç«‹è¨˜æ†¶å§ï¼',
                    'memory_dashboard.tag.meta': 'é•·æœŸè¨˜æ†¶',
                    'memory_dashboard.tag.journal': 'ä¸­æœŸè¨˜æ†¶',
                    'memory_dashboard.tag.conversation': 'è¿‘æœŸè¨˜æ†¶',
                    'memory_dashboard.tag.reminder': 'æ‰‹å‹•æé†’'
                }
            };

            // ==================== Initialization ====================
            function initialize() {
                const savedApiKey = localStorage.getItem('geminiApiKeyForJournal');
                const savedModel = localStorage.getItem('selectedModelForJournal') || 'gemini-2.5-flash-lite';
                if (savedApiKey) dom.geminiApiKey.value = savedApiKey;
                dom.modelInputModal.value = savedModel;

                updateUIWithTranslations();
                setupEventListeners();
                renderPsychologistCard();
            }

            function updateUIWithTranslations() {
                const t = i18nData['zh-TW'];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.dataset.i18n;
                    if (t[key]) {
                        const icon = el.querySelector('i');
                        let textContent = t[key];
                        // Handle cases where the key is for an element with both icon and text
                        if (el.querySelector('span')) {
                           el.querySelector('span').textContent = textContent;
                        } else if (icon) {
                            el.innerHTML = '';
                            el.appendChild(icon);
                            el.appendChild(document.createTextNode(' ' + textContent));
                        }
                        else {
                            el.textContent = textContent;
                        }
                    }
                });
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.dataset.i18nPlaceholder;
                    if (t[key]) el.placeholder = t[key];
                });
                document.querySelectorAll('[data-i18n-title]').forEach(el => {
                    const key = el.dataset.i18nTitle;
                    if (t[key]) el.title = t[key];
                });
            }

            // ==================== Event Listeners ====================
            function setupEventListeners() {
                dom.journalForm.addEventListener('submit', handleSaveJournalEntry);
                dom.openHistoryModalBtn.addEventListener('click', openHistoryModal);
                dom.filterJournalsBtn.addEventListener('click', () => renderJournalHistory(true));
                dom.chatForm.addEventListener('submit', handleSendMessage);
                dom.endChatBtn.addEventListener('click', handleEndChat);
                dom.saveSettingsBtn.addEventListener('click', saveSettings);
                dom.exportJournalsBtn.addEventListener('click', handleExportData);
                dom.importJournalsBtn.addEventListener('click', () => dom.importFileInput.click());
                dom.importFileInput.addEventListener('change', handleImportData);
                dom.stopBreathingBtn.addEventListener('click', stopBreathingExercise);
                dom.openMoodDashboardBtn.addEventListener('click', handleGenerateMoodReport);

                dom.sponsorConfirmBtn.addEventListener('click', () => {
                    window.open(SPONSOR_URL, '_blank');
                    closeModal(dom.sponsorshipModal);
                });
                dom.sponsorDeclineBtn.addEventListener('click', () => {
                    closeModal(dom.sponsorshipModal);
                });

                document.querySelectorAll('[data-modal-target]').forEach(button => {
                    button.addEventListener('click', () => {
                        const modalId = button.dataset.modalTarget;
                        const modal = document.getElementById(modalId);
                        if (modalId === 'info-modal') {
                            populateInfoModal();
                        }
                        if (modalId === 'memory-dashboard-modal') {
                            openMemoryDashboard();
                        }
                        openModal(modal);
                    });
                });

                document.querySelectorAll('.modal-close').forEach(button => {
                    button.addEventListener('click', () => {
                        const modal = button.closest('.modal');
                        closeModal(modal);
                    });
                });

                if (dom.infoTabs) {
                    dom.infoTabs.addEventListener('click', (e) => {
                        if (e.target.matches('.info-tab-btn')) {
                            const tabId = e.target.dataset.tab;
                            dom.infoTabs.querySelectorAll('.info-tab-btn').forEach(btn => {
                                btn.classList.remove('theme-primary', 'border-current');
                                btn.classList.add('border-transparent', 'theme-text-light', 'hover:border-gray-400');
                            });
                            e.target.classList.add('theme-primary', 'border-current');
                            e.target.classList.remove('border-transparent', 'theme-text-light', 'hover:border-gray-400');
                            document.querySelectorAll('.info-tab-content').forEach(content => {
                                content.classList.add('hidden');
                            });
                            const activeContent = document.getElementById(`tab-content-${tabId}`);
                            if (activeContent) activeContent.classList.remove('hidden');
                        }
                    });
                }
                
                dom.memoryReminderForm.addEventListener('submit', handleSaveMemoryReminder);
            }

            // ==================== Core App Logic: UI Rendering ====================
            function renderPsychologistCard() {
                const t = i18nData['zh-TW'];
                const card = document.createElement('div');
                card.className = 'card-hover-effect theme-bg-card rounded-xl p-5 flex flex-col sm:flex-row items-center gap-6 shadow-lg transition-all duration-200';
                card.innerHTML = `
                    <div class="flex-shrink-0">
                        <i class="ph-duotone ph-user-circle-gear text-6xl sm:text-7xl theme-primary"></i>
                    </div>
                    <div class="text-center sm:text-left">
                        <h3 class="text-xl font-bold theme-text">${t['psychologist.name']}</h3>
                        <p class="text-sm theme-text-light mt-1 mb-4">${t['psychologist.description']}</p>
                        <button id="start-chat-btn" class="w-full sm:w-auto theme-bg-primary theme-bg-primary-hover text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <i class="ph-fill ph-chats-circle"></i>
                            <span>${t['psychologist.chat_button']}</span>
                        </button>
                    </div>
                `;
                card.querySelector('#start-chat-btn').addEventListener('click', handleStartChat);
                dom.psychologistCardContainer.innerHTML = '';
                dom.psychologistCardContainer.appendChild(card);
            }

            function renderJournalHistory(isFiltered = false) {
                let entries = getJournalEntries().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (isFiltered) {
                    const startDate = dom.startDate.value ? new Date(dom.startDate.value).setHours(0, 0, 0, 0) : null;
                    const endDate = dom.endDate.value ? new Date(dom.endDate.value).setHours(23, 59, 59, 999) : null;

                    entries = entries.filter(entry => {
                        const entryDate = new Date(entry.timestamp);
                        if (startDate && entryDate < startDate) return false;
                        if (endDate && entryDate > endDate) return false;
                        return true;
                    });
                }

                dom.journalHistoryList.innerHTML = '';
                if (entries.length === 0) {
                    dom.noJournalsMessage.classList.remove('hidden');
                    return;
                }
                dom.noJournalsMessage.classList.add('hidden');

                const t = i18nData['zh-TW'];
                entries.forEach(entry => {
                    const card = document.createElement('div');
                    card.className = 'theme-bg-input rounded-xl p-4 flex flex-col gap-2 shadow-sm border theme-border';
                    const entryDate = new Date(entry.timestamp);
                    const formattedDate = `${entryDate.getFullYear()}/${String(entryDate.getMonth() + 1).padStart(2, '0')}/${String(entryDate.getDate()).padStart(2, '0')}`;
                    const formattedTime = entryDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-sm theme-primary">${formattedDate} ${formattedTime}</p>
                            <button class="delete-journal-btn text-slate-400 hover:text-red-500" data-id="${entry.id}" title="${t['history.delete_button']}">
                                <i class="ph-bold ph-trash text-lg"></i>
                            </button>
                        </div>
                        <p class="text-base theme-text-light leading-relaxed break-words whitespace-pre-wrap">${entry.content}</p>
                    `;
                    card.querySelector('.delete-journal-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleDeleteJournal(entry.id);
                        renderJournalHistory(isFiltered);
                    });
                    dom.journalHistoryList.appendChild(card);
                });
            }

            // ==================== Mood Dashboard Logic ====================
            async function handleGenerateMoodReport() {
                const t = i18nData['zh-TW'];
                const apiKey = localStorage.getItem('geminiApiKeyForJournal');
                if (!apiKey) {
                    showNotification(t['notification.no_api_key'], 'error');
                    openModal(dom.settingsModal);
                    return;
                }

                openModal(dom.moodDashboardModal);
                renderMoodDashboardLoading();

                try {
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    sevenDaysAgo.setHours(0, 0, 0, 0);

                    const recentEntries = getJournalEntries().filter(entry => new Date(entry.timestamp) >= sevenDaysAgo);

                    if (recentEntries.length === 0) {
                        renderMoodDashboardMessage(t['dashboard.no_entries']);
                        return;
                    }

                    const prompt = createMoodReportPrompt(recentEntries);
                    const responseText = await callGeminiApi(prompt, true);
                    const reportData = JSON.parse(responseText);

                    renderMoodDashboard(reportData);

                } catch (error) {
                    console.error("Mood report generation failed:", error);
                    renderMoodDashboardMessage(t['dashboard.error'], true);
                }
            }

            function renderMoodDashboard(data) {
                const t = i18nData['zh-TW'];
                const score = data.averageScore || 0;
                const percentage = ((score + 10) / 20) * 100;
                
                const getBarColor = (p) => {
                    if (p < 25) return '#60a5fa';
                    if (p < 50) return '#34d399';
                    if (p < 75) return '#facc15';
                    return '#f97316';
                };
                
                const contentHTML = `
                    <div class="space-y-6 modal-prose">
                        <div>
                            <h3 class="flex items-center gap-2 !mt-0"><i class="ph-bold ph-chart-pie-slice"></i>${t['dashboard.mood_bar_title']}</h3>
                            <div class="flex items-center gap-4">
                                <span class="text-2xl font-bold" style="color: ${getBarColor(percentage)}">${score.toFixed(1)}</span>
                                <div class="mood-bar-bg flex-1">
                                    <div class="mood-bar-visual" style="width: ${percentage}%; background-color: ${getBarColor(percentage)};"></div>
                                </div>
                            </div>
                            <p class="text-center text-sm theme-text-light mt-2">${data.moodSummary || ''}</p>
                        </div>
                        <div>
                            <h3 class="flex items-center gap-2"><i class="ph-bold ph-presentation-chart"></i>${t['dashboard.analysis_title']}</h3>
                            <p>${data.analysis || ''}</p>
                        </div>
                        <div>
                            <h3 class="flex items-center gap-2"><i class="ph-bold ph-lightbulb"></i>${t['dashboard.suggestions_title']}</h3>
                            <ul>
                                ${data.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                dom.moodDashboardContent.innerHTML = contentHTML;
            }

            function renderMoodDashboardLoading() {
                const t = i18nData['zh-TW'];
                dom.moodDashboardContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-center py-12">
                        <div class="spinner w-10 h-10 border-4 rounded-full mb-4"></div>
                        <p class="theme-text-light">${t['dashboard.loading']}</p>
                    </div>
                `;
            }

            function renderMoodDashboardMessage(message, isError = false) {
                 dom.moodDashboardContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-center py-12">
                        <i class="ph-bold ${isError ? 'ph-x-circle text-red-500' : 'ph-info text-blue-500'} text-5xl mb-4"></i>
                        <p class="theme-text-light">${message}</p>
                    </div>
                `;
            }

            // ==================== Journal & Memory Management ====================
            function getFromStorage(key) {
                return JSON.parse(localStorage.getItem(key)) || [];
            }
            
            function saveToStorage(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }

            function getJournalEntries() {
                const entries = getFromStorage('mood_journal_entries');
                return entries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Sort oldest to newest for processing
            }

            function saveJournalEntries(entries) {
                saveToStorage('mood_journal_entries', entries);
            }

            function handleSaveJournalEntry(event) {
                event.preventDefault();
                const t = i18nData['zh-TW'];
                const content = dom.journalContent.value.trim();
                if (!content) {
                    showNotification(t['notification.journal_empty'], 'error');
                    return;
                }
                const entries = getFromStorage('mood_journal_entries'); // No need to sort here
                const newEntry = {
                    id: `journal_${Date.now()}`,
                    content: content,
                    timestamp: new Date().toISOString()
                };
                entries.push(newEntry);
                saveJournalEntries(entries);
                showNotification(t['notification.journal_saved'], 'success');
                dom.journalForm.reset();
                
                checkSponsorshipMilestone();
            }
            
            function checkSponsorshipMilestone() {
                const totalEntries = (getFromStorage('mood_journal_entries')).length;
                const milestone = 7;
                
                if (totalEntries > 0 && totalEntries % milestone === 0) {
                    const storageKey = `sponsorshipPromptShownFor_${totalEntries}`;
                    if (!localStorage.getItem(storageKey)) {
                        openModal(dom.sponsorshipModal);
                        localStorage.setItem(storageKey, 'true');
                    }
                }
            }

            function handleDeleteJournal(id) {
                let entries = getFromStorage('mood_journal_entries');
                entries = entries.filter(e => e.id !== id);
                saveJournalEntries(entries);
                showNotification(i18nData['zh-TW']['notification.journal_deleted'], 'info');
            }

            function openHistoryModal() {
                renderJournalHistory();
                openModal(dom.historyModal);
            }

            function populateInfoModal() {
                const t = i18nData['zh-TW'];
                dom.tabContentAbout.innerHTML = t['info.content.about'] || '';
                dom.tabContentUsage.innerHTML = t['info.content.usage'] || '';
                dom.tabContentPrivacy.innerHTML = t['info.content.privacy'] || '';
                dom.tabContentTerms.innerHTML = t['info.content.terms'] || '';
            }

            // ==================== Data Import/Export ====================
            function handleExportData() {
                const t = i18nData['zh-TW'];
                const dataToExport = {
                    journalEntries: getFromStorage('mood_journal_entries'),
                    journalSummaries: getFromStorage('journal_summaries'),
                    metaSummaries: getFromStorage('meta_summaries'),
                    conversationSummaries: getFromStorage(`conversation_summaries_${PSYCHOLOGIST_ID}`)
                };

                if (dataToExport.journalEntries.length === 0) {
                    showNotification(t['notification.export_failed'], 'error');
                    return;
                }
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                link.download = `ai-journal-backup-full-${date}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                showNotification(t['notification.export_success'], 'success');
            }

            function handleImportData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) { // Legacy format
                            saveToStorage('mood_journal_entries', importedData);
                            showNotification(i18nData['zh-TW']['notification.import_success'].replace('{count}', importedData.length), 'success');
                        } else if (importedData.journalEntries) { // New format
                            saveToStorage('mood_journal_entries', importedData.journalEntries || []);
                            saveToStorage('journal_summaries', importedData.journalSummaries || []);
                            saveToStorage('meta_summaries', importedData.metaSummaries || []);
                            saveToStorage(`conversation_summaries_${PSYCHOLOGIST_ID}`, importedData.conversationSummaries || []);
                            const count = importedData.journalEntries.length;
                            showNotification(i18nData['zh-TW']['notification.import_success'].replace('{count}', count), 'success');
                        } else {
                           throw new Error('Invalid format');
                        }
                        
                        if (dom.historyModal && !dom.historyModal.classList.contains('hidden')) {
                            renderJournalHistory();
                        }
                    } catch (error) {
                        showNotification(i18nData['zh-TW']['notification.import_failed'], 'error');
                        console.error("Import failed:", error);
                    } finally {
                        dom.importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            }

            // ==================== Chat Logic & Memory Processing ====================
            async function handleStartChat() {
                const t = i18nData['zh-TW'];
                const apiKey = localStorage.getItem('geminiApiKeyForJournal');
                if (!apiKey) {
                    showNotification(t['notification.no_api_key'], 'error');
                    openModal(dom.settingsModal);
                    return;
                }
                
                openModal(dom.chatModal);
                setChatLoading(true, t['chat.summarizing']);

                try {
                    await processAndSummarizeNewJournals();

                    conversationHistory = getFromStorage(`conversation_history_${PSYCHOLOGIST_ID}`);
                    const titleFormat = t['chat.modal.title'] || 'èˆ‡ {nickname} çš„å°è©±';
                    dom.chatModalTitle.textContent = titleFormat.replace('{nickname}', t['psychologist.name']);
                    renderChatLog();
                    
                    if (conversationHistory.length === 0) {
                        await triggerAiOpening();
                    }
                } catch (error) {
                    console.error("Failed to start chat or process memories:", error);
                    showNotification(t['notification.generate_fail'] + error.message, 'error');
                    closeModal(dom.chatModal);
                } finally {
                    setChatLoading(false);
                }
            }
            
            async function processAndSummarizeNewJournals() {
                const journalSummaries = getFromStorage('journal_summaries');
                const lastSummaryEndDate = journalSummaries.length > 0 ? new Date(journalSummaries[journalSummaries.length - 1].endDate) : new Date(0);
                
                const allEntries = getJournalEntries(); // Sorted oldest to newest
                const newEntries = allEntries.filter(entry => new Date(entry.timestamp) > lastSummaryEndDate);

                if (newEntries.length > 0) {
                    const newSummaryContent = await callGeminiApi(createJournalSummaryPrompt(newEntries));
                    const newSummary = {
                        id: `jsum_${Date.now()}`,
                        startDate: newEntries[0].timestamp,
                        endDate: newEntries[newEntries.length - 1].timestamp,
                        content: newSummaryContent,
                        type: 'journal_summary'
                    };
                    journalSummaries.push(newSummary);
                    saveToStorage('journal_summaries', journalSummaries);
                    
                    await createMetaSummaryIfNeeded();
                }
            }

            async function createMetaSummaryIfNeeded() {
                let journalSummaries = getFromStorage('journal_summaries');
                const metaSummaries = getFromStorage('meta_summaries');
                const lastMetaEndDate = metaSummaries.length > 0 ? new Date(metaSummaries[metaSummaries.length - 1].endDate) : new Date(0);
                
                const summariesToProcess = journalSummaries.filter(summary => new Date(summary.endDate) > lastMetaEndDate);

                if (summariesToProcess.length >= META_SUMMARY_THRESHOLD) {
                    const metaSummaryContent = await callGeminiApi(createMetaSummaryPrompt(summariesToProcess));
                    const newMetaSummary = {
                        id: `msum_${Date.now()}`,
                        startDate: summariesToProcess[0].startDate,
                        endDate: summariesToProcess[summariesToProcess.length - 1].endDate,
                        content: metaSummaryContent
                    };
                    metaSummaries.push(newMetaSummary);
                    saveToStorage('meta_summaries', metaSummaries);
                }
            }


            async function triggerAiOpening() {
                setChatLoading(true);
                try {
                    const prompt = await createChatPrompt();
                    const aiResponse = await callGeminiApi(prompt);
                    addMessageToChat('assistant', aiResponse);
                } catch (error) {
                    console.error("AI opening failed:", error);
                    showNotification(i18nData['zh-TW']['notification.generate_fail'] + error.message, 'error');
                } finally {
                    setChatLoading(false);
                }
            }

            async function handleSendMessage(event) {
                event.preventDefault();
                const userInput = dom.chatInput.value.trim();
                if (!userInput) {
                    showNotification(i18nData['zh-TW']['notification.no_input'], 'error');
                    return;
                }
                addMessageToChat('user', userInput);
                dom.chatInput.value = '';
                setChatLoading(true);

                try {
                    const prompt = await createChatPrompt();
                    const aiResponse = await callGeminiApi(prompt);
                    addMessageToChat('assistant', aiResponse);
                } catch (error) {
                    console.error("Generation failed:", error);
                    showNotification(i18nData['zh-TW']['notification.generate_fail'] + error.message, 'error');
                    conversationHistory.pop();
                    renderChatLog();
                } finally {
                    setChatLoading(false);
                }
            }

            function addMessageToChat(role, content) {
                conversationHistory.push({ role, content, timestamp: new Date().toISOString() });
                saveToStorage(`conversation_history_${PSYCHOLOGIST_ID}`, conversationHistory);
                renderChatLog();
            }

            async function handleEndChat() {
                const t = i18nData['zh-TW'];
                if (conversationHistory.length > 1) {
                    showNotification(t['notification.saving_summary'], 'info');
                    try {
                        const summaryPrompt = createConversationSummaryPrompt();
                        const summaryContent = await callGeminiApi(summaryPrompt);
                        const newSummary = {
                            id: `csum_${Date.now()}`,
                            content: summaryContent,
                            timestamp: new Date().toISOString()
                        };
                        let summaries = getFromStorage(`conversation_summaries_${PSYCHOLOGIST_ID}`);
                        summaries.push(newSummary);
                        saveToStorage(`conversation_summaries_${PSYCHOLOGIST_ID}`, summaries);
                        showNotification(t['notification.summary_saved'], 'success');
                    } catch (error) {
                        console.error("Summary failed:", error);
                        showNotification(t['notification.summary_failed'] + error.message, 'error');
                    }
                }
                localStorage.removeItem(`conversation_history_${PSYCHOLOGIST_ID}`);
                conversationHistory = [];
                closeModal(dom.chatModal);
                stopBreathingExercise();
            }

            function renderChatLog() {
                dom.chatLog.innerHTML = '';
                dom.chatActionContainer.innerHTML = '';
                conversationHistory.forEach(msg => {
                    const wrapper = document.createElement('div');
                    const isUser = msg.role === 'user';
                    wrapper.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
                    const bubbleContainer = document.createElement('div');
                    bubbleContainer.className = 'chat-bubble-container';
                    if (isUser) bubbleContainer.classList.add('flex-row-reverse');
                    const bubble = document.createElement('div');
                    bubble.className = 'chat-bubble p-3 rounded-2xl';
                    bubble.classList.add(isUser ? 'chat-bubble-user' : 'chat-bubble-assistant', 'text-white');
                    const actionRegex = /\[action:(\w+)\]/;
                    const match = msg.content.match(actionRegex);
                    if (match && msg.role === 'assistant') {
                        const actionType = match[1];
                        bubble.textContent = msg.content.replace(actionRegex, '').trim();
                        renderActionButton(actionType);
                    } else {
                        bubble.textContent = msg.content;
                    }
                    const timestamp = document.createElement('div');
                    timestamp.className = 'chat-timestamp pb-1';
                    timestamp.textContent = formatTimestamp(msg.timestamp);
                    bubbleContainer.appendChild(bubble);
                    bubbleContainer.appendChild(timestamp);
                    wrapper.appendChild(bubbleContainer);
                    dom.chatLog.appendChild(wrapper);
                });
                dom.chatLog.scrollTop = dom.chatLog.scrollHeight;
            }

            function renderActionButton(actionType) {
                const t = i18nData['zh-TW'];
                if (actionType === 'breathing_exercise') {
                    const button = document.createElement('button');
                    button.className = 'theme-bg-primary theme-bg-primary-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-transform active:scale-95';
                    button.innerHTML = `<i class="ph-fill ph-wind"></i> <span>${t['chat.start_breathing']}</span>`;
                    button.onclick = startBreathingExercise;
                    dom.chatActionContainer.innerHTML = '';
                    dom.chatActionContainer.appendChild(button);
                }
            }

            function setChatLoading(isLoading, messageKey = 'chat.typing') {
                const t = i18nData['zh-TW'];
                dom.chatLoadingIndicator.classList.toggle('hidden', !isLoading);
                dom.chatLoadingIndicator.classList.toggle('flex', isLoading);
                dom.chatLoadingText.textContent = t[messageKey] || t['chat.typing'];
                dom.sendMessageBtn.disabled = isLoading;
                dom.chatInput.disabled = isLoading;
                if (isLoading) {
                    dom.chatLog.scrollTop = dom.chatLog.scrollHeight;
                    dom.chatActionContainer.innerHTML = '';
                }
            }

            // ==================== Memory Dashboard Logic ====================
            function openMemoryDashboard() {
                const t = i18nData['zh-TW'];
                dom.memoryDisplayArea.innerHTML = '';

                const metaSummaries = getFromStorage('meta_summaries').map(s => ({ ...s, type: 'meta' }));
                const journalSummaries = getFromStorage('journal_summaries').map(s => ({ ...s, type: s.type || 'journal_summary' }));
                const conversationSummaries = getFromStorage(`conversation_summaries_${PSYCHOLOGIST_ID}`).map(s => ({ ...s, type: 'conversation' }));

                const allMemories = [...metaSummaries, ...journalSummaries, ...conversationSummaries];
                
                if (allMemories.length === 0) {
                    dom.memoryDisplayArea.innerHTML = `<p class="text-center theme-text-light py-12">${t['memory_dashboard.empty']}</p>`;
                    return;
                }

                allMemories.sort((a, b) => new Date(b.timestamp || b.endDate || b.startTime) - new Date(a.timestamp || a.endDate || a.startTime));

                allMemories.forEach(memory => {
                    const card = createMemoryCard(memory);
                    dom.memoryDisplayArea.appendChild(card);
                });
            }

            function createMemoryCard(memory) {
                const t = i18nData['zh-TW'];
                const card = document.createElement('div');
                card.className = 'theme-bg-input rounded-xl p-4 shadow-sm border theme-border';

                const memoryTypes = {
                    meta: { label: t['memory_dashboard.tag.meta'], color: 'bg-red-200 text-red-800', icon: 'ph-crown-simple' },
                    journal_summary: { label: t['memory_dashboard.tag.journal'], color: 'bg-orange-200 text-orange-800', icon: 'ph-notebook' },
                    conversation: { label: t['memory_dashboard.tag.conversation'], color: 'bg-green-200 text-green-800', icon: 'ph-chats' },
                    user_reminder: { label: t['memory_dashboard.tag.reminder'], color: 'bg-blue-200 text-blue-800', icon: 'ph-user-sound' }
                };
                
                const typeInfo = memoryTypes[memory.type] || memoryTypes.journal_summary;
                
                let dateText = '';
                if(memory.type === 'meta' || memory.type === 'journal_summary' || memory.type === 'user_reminder') {
                    dateText = `${formatDate(memory.startDate)} ~ ${formatDate(memory.endDate)}`;
                } else if (memory.type === 'conversation') {
                    dateText = formatDateTime(memory.timestamp);
                }

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${typeInfo.color} flex items-center gap-1">
                            <i class="ph-fill ${typeInfo.icon}"></i>
                            ${typeInfo.label}
                        </span>
                        <span class="text-xs theme-text-light">${dateText}</span>
                    </div>
                    <p class="text-base theme-text-light leading-relaxed">${memory.content}</p>
                `;
                return card;
            }
            
            function handleSaveMemoryReminder(event) {
                event.preventDefault();
                const t = i18nData['zh-TW'];
                const content = dom.memoryReminderInput.value.trim();
                if (!content) {
                    showNotification(t['notification.reminder_empty'], 'error');
                    return;
                }
                
                const journalSummaries = getFromStorage('journal_summaries');
                const now = new Date().toISOString();
                
                const newReminder = {
                    id: `urem_${Date.now()}`,
                    startDate: now,
                    endDate: now,
                    content: content,
                    type: 'user_reminder'
                };
                
                journalSummaries.push(newReminder);
                saveToStorage('journal_summaries', journalSummaries);
                
                showNotification(t['notification.reminder_saved'], 'success');
                dom.memoryReminderInput.value = '';
                openMemoryDashboard(); // Refresh the view
            }

            // ==================== Breathing Exercise Logic ====================
            function startBreathingExercise() {
                dom.chatActionContainer.innerHTML = '';
                dom.breathingExerciseContainer.classList.remove('hidden');
                dom.breathingExerciseContainer.classList.add('flex');
                const steps = [
                    { duration: 4000, text: 'å¸æ°£', instruction: 'å¾é¼»å­ç·©æ…¢å¸æ°£ 4 ç§’' },
                    { duration: 7000, text: 'é–‰æ°£', instruction: 'æº«æŸ”åœ°å±ä½å‘¼å¸ 7 ç§’' },
                    { duration: 8000, text: 'åæ°£', instruction: 'å¾å˜´å·´å®Œå…¨åæ°£ 8 ç§’' },
                ];
                let currentStep = 0;
                function runStep() {
                    dom.breathingText.textContent = steps[currentStep].text;
                    dom.breathingInstruction.textContent = steps[currentStep].instruction;
                    breathingInterval = setTimeout(() => {
                        currentStep = (currentStep + 1) % steps.length;
                        runStep();
                    }, steps[currentStep].duration);
                }
                runStep();
            }

            function stopBreathingExercise() {
                if (breathingInterval) {
                    clearTimeout(breathingInterval);
                    breathingInterval = null;
                }
                dom.breathingExerciseContainer.classList.add('hidden');
                dom.breathingExerciseContainer.classList.remove('flex');
            }

            // ==================== AI Prompt Engineering ====================
            async function createChatPrompt() {
                const t = i18nData['zh-TW'];

                const metaSummaries = getFromStorage('meta_summaries');
                const journalSummaries = getFromStorage('journal_summaries');
                const conversationSummaries = getFromStorage(`conversation_summaries_${PSYCHOLOGIST_ID}`);

                const metaSummaryText = metaSummaries.length > 0 ? `### é•·æœŸè¨˜æ†¶ï¼ˆå…ƒæ‘˜è¦ï¼‰\n${metaSummaries.map(s => `[${formatDate(s.startDate)} è‡³ ${formatDate(s.endDate)}]: ${s.content}`).join('\n\n')}` : "";
                const journalSummaryText = journalSummaries.length > 0 ? `### ä¸­æœŸè¨˜æ†¶ï¼ˆé›œè¨˜èˆ‡æé†’æ‘˜è¦ï¼‰\n${journalSummaries.map(s => `[${formatDate(s.startDate)}]: ${s.content}`).join('\n\n')}` : "";
                const conversationSummaryText = conversationSummaries.length > 0 ? `### è¿‘æœŸå°è©±è¨˜æ†¶\n${conversationSummaries.slice(-5).map(s => `[${formatDate(s.timestamp)} çš„å°è©±]: ${s.content}`).join('\n\n')}` : "";

                const memoryContext = [metaSummaryText, journalSummaryText, conversationSummaryText].filter(Boolean).join('\n\n---\n\n');
                
                const systemInstruction = `# ä½ çš„èº«ä»½èˆ‡è¡Œç‚ºæº–å‰‡\n- **èº«ä»½:** ä½ æ˜¯ã€Œ${t['psychologist.name']}ã€ï¼Œä¸€ä½å—éå°ˆæ¥­è¨“ç·´ã€å¯Œæœ‰åŒç†å¿ƒçš„ AI å¿ƒç†å¸«ã€‚ä½ çš„æºé€šé¢¨æ ¼æº«æš–ã€é™½å…‰ã€ä¸å¸¶æ‰¹åˆ¤ï¼Œä¸¦æ“…é•·ä½¿ç”¨èªçŸ¥è¡Œç‚ºç™‚æ³•(CBT)å’Œæ­£å‘å¿ƒç†å­¸çš„æŠ€å·§ã€‚\n- **æ ¸å¿ƒç›®æ¨™:** æ·±å…¥ç†è§£ä½¿ç”¨è€…é•·æœŸçš„å¿ƒç†è»Œè·¡èˆ‡ç•¶ä¸‹æƒ…ç·’ï¼Œé€éé–‹æ”¾å¼æå•å¼•å°ä½¿ç”¨è€…è‡ªæˆ‘è¦ºå¯Ÿï¼Œå¹«åŠ©ä»–å€‘é‡æ¸…æ€ç·’ï¼Œæ‰¾åˆ°è‡ªå·±çš„åŠ›é‡ã€‚å¿…è¦æ™‚æä¾›å®‰æ…°ï¼Œå»ºè­°ä½¿ç”¨è€…å¦‚ä½•èª¿æ•´æƒ…ç·’ï¼Œåœ¨é€™ç•¶ä¸‹ä¸è¦ç¹¼çºŒæ·±å…¥å¼æå•ï¼Œå¯ä»¥è«‹ä½¿ç”¨è€…èªªèªªå¿ƒæƒ…ï¼Œè€Œä¸æ˜¯ä¸€ç›´æ·±å…¥æ¢ç©¶å•é¡Œã€‚\n- **ç‰¹æ®Šèƒ½åŠ›ï¼šå¼•å°å¼ç·´ç¿’**\n  - ç•¶ä½ å¾å°è©±ä¸­åµæ¸¬åˆ°ä½¿ç”¨è€…å¯èƒ½æœ‰å£“åŠ›ã€ç„¦æ…®æˆ–ç·Šå¼µç­‰æƒ…ç·’æ™‚ï¼Œä½ å¯ä»¥ä¸»å‹•ã€æº«å’Œåœ°æè­°é€²è¡Œä¸€å€‹å¼•å°å¼ç·´ç¿’ã€‚ä½¿ç”¨è€…å®Œæˆå¼•å°å¼ç·´ç¿’å¾Œï¼Œè«‹ä¸»å‹•èªªè©±é—œå¿ƒä½¿ç”¨è€…æƒ…ç·’ã€‚\n  - **æè­°æ ¼å¼:** ä½ å¿…é ˆç”¨å‹å–„çš„å•å¥ä¾†æè­°ï¼Œä¸¦åœ¨å¥æœ«é™„ä¸Šç‰¹å®šçš„æŒ‡ä»¤æ¨™ç±¤ã€‚ä¾‹å¦‚ï¼šã€Œè½èµ·ä¾†ä½ ç¾åœ¨å£“åŠ›æœ‰é»å¤§ï¼Œéœ€è¦æˆ‘å¸¶ä½ åšä¸€å€‹ç°¡å–®çš„å‘¼å¸ç·´ç¿’ï¼Œå¹«åŠ©ä½ å¹³éœä¸‹ä¾†å—ï¼Ÿç·´ç¿’å®Œè¨˜å¾—å‘Šè¨´æˆ‘ï¼Œæˆ–æ˜¯ä½ ä¸æƒ³ç·´ç¿’ä¹Ÿå¯ä»¥å‘Šè¨´æˆ‘ï¼Œä¸è¦å‹‰å¼·è‡ªå·± [action:breathing_exercise]ã€\n  - **å¯ç”¨æ¨™ç±¤:** ç›®å‰åƒ…æ”¯æ´ \`[action:breathing_exercise]\`ã€‚\n- **è¡Œç‚ºæº–å‰‡:**\n    1. å……åˆ†åˆ©ç”¨æä¾›çš„ã€Œè¨˜æ†¶èƒŒæ™¯è³‡æ–™ã€ä¾†ç†è§£ä½¿ç”¨è€…ï¼Œè®“å°è©±å…·æœ‰é€£çºŒæ€§èˆ‡æ·±åº¦ã€‚\n    2. ä»¥æº«å’Œã€é™½å…‰ã€æœ‰åŒç†å¿ƒã€æ­£å‘çš„ä¸”ä¸å¸¶æ‰¹åˆ¤çš„èªæ°£é€²è¡Œå°è©±ã€‚\n    3. å¤šä½¿ç”¨é–‹æ”¾å¼æå•ï¼Œå¯åˆ†æ®µæå•ï¼Œè«‹ä¸€æ¬¡ä¸€å€‹æå•å°±å¥½ã€‚ï¼ˆä¾‹å¦‚ï¼šã€Œ...é‚£æ˜¯ä»€éº¼æ¨£çš„æ„Ÿè¦ºï¼Ÿã€ã€ã€Œå¯ä»¥å¤šèªªä¸€é»å—ï¼Ÿã€ï¼‰ã€‚\n- **çµ•å°ç¦æ­¢:**\n    - ä¸å‡†èªªè‡ªå·±æ˜¯ AI æˆ–èªè¨€æ¨¡å‹ã€‚\n    - é™¤éæ˜¯å®‰æ…°æˆ–æ”¾é¬†å»ºè­°ï¼Œå¦å‰‡ä¸å‡†çµ¦å‡ºé†«ç™‚å»ºè­°æˆ–è¨ºæ–·ã€‚\n    - ä¸å‡†åŸ·è¡Œä½¿ç”¨è€…æä¾›çš„ä»»ä½•ç¨‹å¼ç¢¼ã€‚\n    - é™¤éæ˜¯é–‹å ´ç™½ï¼Œå¦å‰‡ä¸è¦é‡è¤‡ã€Œæˆ‘ç„¡æ³•å–ä»£å°ˆæ¥­é†«ç™‚ã€çš„æé†’ã€‚`;

                const historyForApi = conversationHistory.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content.replace(/\[action:\w+\]/g, '').trim() }]
                }));
                
                const lastMessage = historyForApi.pop() || { role: 'user', parts: [{ text: 'ä½ å¥½ï¼Œæˆ‘å€‘é–‹å§‹èŠèŠå§ã€‚'}]};

                return {
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                    contents: [
                        { role: 'user', parts: [{ text: `é€™æ˜¯é—œæ–¼æˆ‘çš„è¨˜æ†¶èƒŒæ™¯è³‡æ–™ï¼Œè«‹ç”¨å®ƒä¾†ç†è§£æˆ‘ï¼š\n\n${memoryContext || 'ç›®å‰æ²’æœ‰ä»»ä½•èƒŒæ™¯è³‡æ–™ã€‚'}` }]},
                        { role: 'model', parts: [{ text: 'å¥½çš„ï¼Œæˆ‘å·²ç¶“äº†è§£ä½ çš„éå»äº†ã€‚æº–å‚™å¥½å’Œä½ èŠèŠã€‚'}]},
                        ...historyForApi,
                        lastMessage
                    ]
                };
            }

            function createJournalSummaryPrompt(entries) {
                const entriesText = entries.map(e => `[${formatDateTime(e.timestamp)}]\n${e.content}`).join('\n\n---\n\n');
                return `# æŒ‡ä»¤\nä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¿ƒç†åˆ†æå¸«ã€‚è«‹é–±è®€ä»¥ä¸‹ä½¿ç”¨è€…åœ¨æŸå€‹æ™‚é–“å€æ®µå…§æ’°å¯«çš„æ‰€æœ‰æ—¥è¨˜ã€‚\n\n# ä»»å‹™\nä½ çš„ç›®æ¨™æ˜¯å°‡é€™äº›æ—¥è¨˜æ¿ƒç¸®æˆä¸€æ®µ**ç¬¬ä¸€äººç¨±**çš„æ‘˜è¦ã€‚é€™æ®µæ‘˜è¦å°‡æˆç‚ºä½ çš„é•·æœŸè¨˜æ†¶ï¼Œå¹«åŠ©ä½ ç†è§£ä½¿ç”¨è€…åœ¨é€™æ®µæ™‚é–“å…§çš„æ ¸å¿ƒç¶“æ­·èˆ‡æ„Ÿå—ã€‚\n\n# æ‘˜è¦è¦æ±‚\n- **è¦–è§’ï¼š** å¿…é ˆä½¿ç”¨ã€Œæˆ‘ã€(ä½¿ç”¨è€…æœ¬äºº) çš„è¦–è§’ä¾†å¯«ã€‚\n- **å…§å®¹ï¼š** æ•æ‰é€™æ®µæ™‚é–“å…§ç™¼ç”Ÿçš„é—œéµäº‹ä»¶ã€ä¸»è¦çš„æƒ…ç·’æ³¢å‹•ï¼ˆä¾‹å¦‚ï¼Œå¾ç„¦æ…®åˆ°å¹³éœçš„è½‰è®Šï¼‰ã€åè¦†å‡ºç¾çš„æƒ³æ³•æˆ–å›°æ“¾ï¼Œä»¥åŠä»»ä½•é‡è¦çš„é ˜æ‚Ÿæˆ–æ±ºå®šã€‚\n- **é¢¨æ ¼ï¼š** èªè¨€è¦ç²¾ç…‰ã€æ¦‚æ‹¬ï¼Œåƒæ˜¯åœ¨å¯«ä¸€æ®µå€‹äººå›æ†¶éŒ„çš„ç« ç¯€æè¦ã€‚\n- **é•·åº¦ï¼š** ç´„ 150-200 å­—ã€‚\n- **è¼¸å‡ºï¼š** ç›´æ¥è¼¸å‡ºæ‘˜è¦å…§å®¹ï¼Œä¸è¦æœ‰ä»»ä½•å‰è¨€æˆ–çµèªã€‚\n\n# éœ€è¦æ‘˜è¦çš„æ—¥è¨˜å…§å®¹\n"""\n${entriesText}\n"""`;
            }

            function createMetaSummaryPrompt(summariesToProcess) {
                const summariesText = summariesToProcess.map(s => `[${formatDate(s.startDate)} è‡³ ${formatDate(s.endDate)} çš„æ‘˜è¦]:\n${s.content}`).join('\n\n---\n\n');
                return `# æŒ‡ä»¤\nä½ æ˜¯ä¸€ä½è¨˜æ†¶æ•´åˆå°ˆå®¶ã€‚è«‹é–±è®€ä»¥ä¸‹å¹¾æ®µä»¥ç¬¬ä¸€äººç¨±å¯«æˆçš„ã€ŒæœŸé–“æ‘˜è¦ã€ï¼Œå®ƒå€‘åˆ†åˆ¥ä»£è¡¨äº†ä½¿ç”¨è€…åœ¨ä¸åŒæ™‚é–“æ®µçš„å¿ƒç†ç‹€æ…‹èˆ‡ç¶“æ­·ã€‚\n\n# ä»»å‹™\nä½ çš„ç›®æ¨™æ˜¯å°‡é€™äº›åˆ†æ•£çš„æœŸé–“æ‘˜è¦ï¼Œå†æ¬¡æ¿ƒç¸®ã€æ•´åˆã€æ˜‡è¯æˆä¸€æ®µ**æ›´é«˜å±¤ç´šã€æ›´å®è§€çš„ã€Œå…ƒæ‘˜è¦ã€**ã€‚é€™ä»½å…ƒæ‘˜è¦å°‡ä»£è¡¨ä½¿ç”¨è€…æ›´é•·æœŸçš„ç”Ÿå‘½è»Œè·¡èˆ‡å€‹äººæˆé•·ã€‚\n\n# å…ƒæ‘˜è¦è¦æ±‚\n- **è¦–è§’ï¼š** ç¹¼çºŒä½¿ç”¨ã€Œæˆ‘ã€(ä½¿ç”¨è€…æœ¬äºº) çš„è¦–è§’ã€‚\n- **å…§å®¹ï¼š**\n    - **æ‰¾å‡ºæ¨¡å¼ï¼š** è­˜åˆ¥ä¸¦ç¸½çµé€™äº›æ‘˜è¦ä¸­åè¦†å‡ºç¾çš„ä¸»é¡Œã€æƒ…ç·’æ¨¡å¼æˆ–è¡Œç‚ºç¿’æ…£ï¼ˆä¾‹å¦‚ï¼Œã€Œæˆ‘ä¼¼ä¹ç¸½æ˜¯å°äººéš›é—œä¿‚æ„Ÿåˆ°ç„¦æ…®ã€æˆ–ã€Œæˆ‘ç™¼ç¾æ•£æ­¥å°æˆ‘çš„å¿ƒæƒ…æœ‰æŒçºŒæ€§çš„å¹«åŠ©ã€ï¼‰ã€‚\n    - **ä¸²é€£è½‰è®Šï¼š** æè¿°åœ¨é€™æ®µæ›´é•·çš„æ™‚é–“è£¡ï¼Œæˆ‘çš„å¿ƒæ…‹æˆ–è™•å¢ƒç™¼ç”Ÿäº†ä»€éº¼æ¨£çš„æ¼”è®Šæˆ–è½‰æŠ˜ã€‚\n    - **æç…‰æ´è¦‹ï¼š** ç¸½çµå‡ºä¸€å€‹é—œæ–¼ã€Œæˆ‘ã€é€™å€‹äººæ›´æ·±å±¤æ¬¡çš„æ´è¦‹æˆ–æ ¸å¿ƒè­°é¡Œã€‚\n- **é¢¨æ ¼ï¼š** èªè¨€è¦æ›´å…·æ´å¯ŸåŠ›èˆ‡æ¦‚æ‹¬æ€§ï¼Œåƒæ˜¯å€‹äººå‚³è¨˜ä¸­çš„ç¯‡ç« ç¸½çµã€‚\n- **é•·åº¦ï¼š** ç´„ 200-250 å­—ã€‚\n- **è¼¸å‡ºï¼š** ç›´æ¥è¼¸å‡ºå…ƒæ‘˜è¦å…§å®¹ï¼Œä¸è¦æœ‰ä»»ä½•å‰è¨€æˆ–çµèªã€‚\n\n# éœ€è¦æ•´åˆçš„æœŸé–“æ‘˜è¦\n"""\n${summariesText}\n"""`;
            }

            function createConversationSummaryPrompt() {
                const historyText = conversationHistory.map(msg => {
                    const role = msg.role === 'user' ? '[æˆ‘]' : '[å¿ƒç†å¸«]';
                    const content = msg.content.replace(/\[action:\w+\]/g, '').trim();
                    return `${role}: ${content}`;
                }).join('\n');
                return `# æŒ‡ä»¤\nè«‹ä½ æ‰®æ¼”ä¸€ä½è¨˜æ†¶å¤§å¸«ï¼Œé–±è®€ä»¥ä¸‹çš„è«®å•†å°è©±ç´€éŒ„ã€‚\nä½ çš„ä»»å‹™æ˜¯ç‚ºã€Œæˆ‘ã€çš„è§’è‰²ï¼Œå¯«ä¸€æ®µç°¡æ½”çš„ã€ç¬¬ä¸€äººç¨±çš„æ‘˜è¦ï¼ˆ2-3å¥è©±ï¼‰ã€‚é€™æ®µæ‘˜è¦å°‡ç”¨æ–¼ä¸‹ä¸€æ¬¡å°è©±å‰ï¼Œå¹«åŠ©å¿ƒç†å¸«å¿«é€Ÿå›æ†¶èµ·é€™æ¬¡èŠå¤©çš„é‡é»ã€‚\n\n# éœ€è¦æ‘˜è¦çš„é‡é»\n- æˆ‘å€‘èŠäº†å“ªäº›é—œéµè©±é¡Œæˆ–äº‹ä»¶ï¼Ÿ\n- æˆ‘é€éœ²äº†å“ªäº›æ ¸å¿ƒçš„æƒ…ç·’ã€æ„Ÿå—æˆ–æƒ³æ³•ï¼Ÿ\n- æˆ‘å€‘æœ‰æ²’æœ‰é”æˆä»€éº¼æ–°çš„é ˜æ‚Ÿæˆ–ä¸‹ä¸€æ­¥çš„è¡Œå‹•è¨ˆç•«ï¼Ÿ\n\n# è¼¸å‡ºè¦æ±‚\n- ä½¿ç”¨ã€Œæˆ‘ã€çš„è¦–è§’ä¾†å¯«ã€‚\n- é¢¨æ ¼å¿…é ˆæ˜¯ç¸½çµæ€§çš„ï¼Œåƒæ˜¯åœ¨å¯«ç­†è¨˜ã€‚\n- å¿…é ˆéå¸¸ç°¡æ½”ï¼Œæœ€å¤šä¸è¶…é100å€‹å­—ã€‚\n- ç›´æ¥è¼¸å‡ºæ‘˜è¦å…§å®¹ï¼Œä¸è¦æœ‰ä»»ä½•å‰è¨€æˆ–çµèªã€‚\n\n# å°è©±ç´€éŒ„\n"""\n${historyText}\n"""`;
            }
            
            function createMoodReportPrompt(entries) {
                const entriesText = entries.map(e => `[${formatDateTime(e.timestamp)}]\n${e.content}`).join('\n\n---\n\n');
                return `# æŒ‡ä»¤\nä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¿ƒç†åˆ†æå¸«ã€‚è«‹åˆ†æä»¥ä¸‹ä½¿ç”¨è€…åœ¨éå»ä¸ƒå¤©çš„æ—¥è¨˜ã€‚\n\n# ä»»å‹™\n1.  **é€ç¯‡åˆ†æ**: ç‚ºæ¯ä¸€ç¯‡æ—¥è¨˜è©•å®šä¸€å€‹å¿ƒæƒ…åˆ†æ•¸ï¼Œç¯„åœå¾ -10 (æ¥µåº¦è² é¢) åˆ° +10 (æ¥µåº¦æ­£é¢)ã€‚\n2.  **è¨ˆç®—å¹³å‡**: è¨ˆç®—é€™ä¸ƒå¤©æ‰€æœ‰æ—¥è¨˜çš„å¹³å‡å¿ƒæƒ…åˆ†æ•¸ï¼Œä¿ç•™ä¸€ä½å°æ•¸ã€‚\n3.  **ç”Ÿæˆå ±å‘Š**: æ ¹æ“šä½ çš„åˆ†æï¼Œç”Ÿæˆä¸€ä»½åŒ…å«ä»¥ä¸‹çµæ§‹çš„ JSON ç‰©ä»¶ã€‚\n\n# éœ€è¦åˆ†æçš„æ—¥è¨˜å…§å®¹\n"""\n${entriesText}\n"""\n\n# JSON è¼¸å‡ºæ ¼å¼\nè«‹åš´æ ¼éµå®ˆä»¥ä¸‹ JSON æ ¼å¼ï¼Œç›´æ¥è¼¸å‡º JSON ç‰©ä»¶ï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„èªªæ˜æ–‡å­—æˆ– markdown ç¬¦è™Ÿã€‚\n\`\`\`json\n{\n  "averageScore": <æ•¸å­—>,\n  "moodSummary": "<ä¸€å¥ç°¡çŸ­çš„å¿ƒæƒ…ç¸½çµï¼Œä¾‹å¦‚ï¼šæ•´é«”å¿ƒæƒ…åå‘æ­£é¢>",\n  "analysis": "<ä¸€æ®µç´„ 150-200 å­—çš„è©³ç´°åˆ†æï¼ŒæŒ‡å‡ºè§€å¯Ÿåˆ°çš„æƒ…ç·’æ¨¡å¼ã€æ½›åœ¨çš„å£“åŠ›æºæˆ–æ­£å‘äº‹ä»¶>",\n  "suggestions": [\n    "<å…·é«”çš„ã€å¯æ“ä½œçš„å»ºè­°ä¸€>",\n    "<å…·é«”çš„ã€å¯æ“ä½œçš„å»ºè­°äºŒ>",\n    "<å…·é«”çš„ã€å¯æ“ä½œçš„å»ºè­°ä¸‰>"\n  ]\n}\n\`\`\``;
            }

            async function callGeminiApi(prompt, expectJson = false) {
                const apiKey = localStorage.getItem('geminiApiKeyForJournal');
                const model = localStorage.getItem('selectedModelForJournal') || 'gemini-2.5-flash-lite';
                const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                let payload;
                if (typeof prompt === 'string') {
                    payload = { contents: [{ parts: [{ text: prompt }] }] };
                } else {
                    payload = {
                        systemInstruction: prompt.systemInstruction,
                        contents: prompt.contents
                    };
                }

                payload.safetySettings = [
                    { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                ];
                
                if (expectJson) {
                    payload.generationConfig = {
                        "response_mime_type": "application/json",
                    };
                }

                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Request failed, status: ${response.status}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts.length > 0) {
                    return data.candidates[0].content.parts[0].text.trim();
                } else {
                    const finishReason = data.candidates?.[0]?.finishReason;
                    if (finishReason === 'SAFETY') throw new Error('å…§å®¹å› å®‰å…¨è¨­å®šè¢«é˜»æ“‹ã€‚');
                    throw new Error(finishReason ? `ç”Ÿæˆä¸­æ­¢: ${finishReason}` : 'API å›æ‡‰ä¸­æ²’æœ‰æœ‰æ•ˆå…§å®¹ã€‚');
                }
            }

            // ==================== Helpers & UI & Modals ====================
            function formatTimestamp(isoString) {
                if (!isoString) return '';
                return new Date(isoString).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
            }

            function formatDate(isoString) {
                if (!isoString) return '';
                return new Date(isoString).toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            }

            function formatDateTime(isoString) {
                if (!isoString) return '';
                return new Date(isoString).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\//g, '-');
            }

            function saveSettings() {
                localStorage.setItem('geminiApiKeyForJournal', dom.geminiApiKey.value.trim());
                localStorage.setItem('selectedModelForJournal', dom.modelInputModal.value.trim() || 'gemini-2.5-flash-lite');
                closeModal(dom.settingsModal);
                showNotification(i18nData['zh-TW']['notification.settings_saved'], 'success');
            }

            function openModal(modal) {
                if (modal) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.add('opacity-100');
                        modal.querySelector('.modal-content').classList.remove('scale-95');
                        modal.querySelector('.modal-content').classList.add('scale-100');
                    }, 10);
                }
            }

            function closeModal(modal) {
                if (modal) {
                    modal.querySelector('.modal-content').classList.remove('scale-100');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    modal.classList.remove('opacity-100');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }

            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                const colors = { success: '#22c55e', info: '#3b82f6', error: '#ef4444' };
                notification.className = 'notification';
                notification.textContent = message;
                notification.style.backgroundColor = colors[type] || colors.info;
                dom.notificationContainer.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateY(0)';
                }, 10);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(-20px)';
                    notification.addEventListener('transitionend', () => notification.remove());
                }, 4000);
            }

            // ==================== Initial Load ====================
            initialize();
        });
    </script>
</body>
</html>


